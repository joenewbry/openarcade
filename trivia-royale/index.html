<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia Royale</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      width: 600px;
    }
    .back { color: #f0a; text-decoration: none; font-size: 1.2rem; }
    .back:hover { text-shadow: 0 0 10px rgba(255, 0, 170, 0.5); }
    h1 { color: #f0a; font-size: 1.6rem; text-shadow: 0 0 15px rgba(255, 0, 170, 0.4); }
    .score-bar {
      display: flex;
      justify-content: space-between;
      width: 600px;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .score-bar span { color: #f0a; }
    canvas {
      border: 2px solid #f0a;
      box-shadow: 0 0 20px rgba(255, 0, 170, 0.2);
      display: block;
      cursor: pointer;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #f0a;
      text-align: center;
      pointer-events: none;
      background: rgba(26, 26, 46, 0.85);
    }
    .overlay h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .overlay p { font-size: 1rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" class="back">&larr; Back</a>
    <h1>TRIVIA ROYALE</h1>
  </div>
  <div class="score-bar">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div style="position: relative; display: inline-block;">
    <canvas id="game" width="600" height="500"></canvas>
    <div class="overlay" id="overlay" style="width:600px;height:500px;">
      <h2 id="overlayTitle">TRIVIA ROYALE</h2>
      <p id="overlayText">Click to Start &mdash; Battle Royale Trivia! Last one standing wins.</p>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = 600, H = 500;
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');

    let gameState = 'waiting';
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('triviaRoyaleBest') || '0');
    bestEl.textContent = bestScore;

    // Prevent scroll on space/arrow
    document.addEventListener('keydown', (e) => {
      if ([' ', 'ArrowUp', 'ArrowDown'].includes(e.key)) e.preventDefault();
    });

    // ===== QUESTION BANK (60 questions, 8 categories) =====
    const questions = [
      // SCIENCE (8)
      { q: "What planet is known as the Red Planet?", a: ["Mars", "Venus", "Jupiter", "Saturn"], c: 0, cat: "Science" },
      { q: "What is the chemical symbol for gold?", a: ["Au", "Ag", "Fe", "Cu"], c: 0, cat: "Science" },
      { q: "How many bones are in the adult human body?", a: ["206", "186", "226", "196"], c: 0, cat: "Science" },
      { q: "What gas do plants absorb from the atmosphere?", a: ["Carbon dioxide", "Oxygen", "Nitrogen", "Hydrogen"], c: 0, cat: "Science" },
      { q: "What is the speed of light in km/s (approx)?", a: ["300,000", "150,000", "500,000", "1,000,000"], c: 0, cat: "Science" },
      { q: "What is the hardest natural substance on Earth?", a: ["Diamond", "Quartz", "Topaz", "Sapphire"], c: 0, cat: "Science" },
      { q: "What organ in the body produces insulin?", a: ["Pancreas", "Liver", "Kidney", "Stomach"], c: 0, cat: "Science" },
      { q: "What is the most abundant gas in Earth's atmosphere?", a: ["Nitrogen", "Oxygen", "Carbon dioxide", "Argon"], c: 0, cat: "Science" },
      // HISTORY (8)
      { q: "In what year did World War II end?", a: ["1945", "1944", "1946", "1943"], c: 0, cat: "History" },
      { q: "Who was the first President of the United States?", a: ["George Washington", "John Adams", "Thomas Jefferson", "Ben Franklin"], c: 0, cat: "History" },
      { q: "The Great Wall was primarily built against whom?", a: ["Mongol invaders", "Japanese", "Koreans", "Russians"], c: 0, cat: "History" },
      { q: "What ancient wonder was in Alexandria, Egypt?", a: ["The Lighthouse", "The Colossus", "Hanging Gardens", "Temple of Artemis"], c: 0, cat: "History" },
      { q: "Which empire was ruled by Genghis Khan?", a: ["Mongol Empire", "Ottoman Empire", "Roman Empire", "Persian Empire"], c: 0, cat: "History" },
      { q: "In what year did the Titanic sink?", a: ["1912", "1905", "1918", "1920"], c: 0, cat: "History" },
      { q: "Who painted the Mona Lisa?", a: ["Leonardo da Vinci", "Michelangelo", "Raphael", "Donatello"], c: 0, cat: "History" },
      { q: "What year did the Berlin Wall fall?", a: ["1989", "1991", "1985", "1990"], c: 0, cat: "History" },
      // GEOGRAPHY (8)
      { q: "What is the largest continent by area?", a: ["Asia", "Africa", "North America", "Europe"], c: 0, cat: "Geography" },
      { q: "What is the longest river in the world?", a: ["Nile", "Amazon", "Mississippi", "Yangtze"], c: 0, cat: "Geography" },
      { q: "Which country has the most time zones?", a: ["France", "Russia", "USA", "China"], c: 0, cat: "Geography" },
      { q: "What is the capital of Australia?", a: ["Canberra", "Sydney", "Melbourne", "Brisbane"], c: 0, cat: "Geography" },
      { q: "What is the smallest country in the world?", a: ["Vatican City", "Monaco", "San Marino", "Liechtenstein"], c: 0, cat: "Geography" },
      { q: "Which desert is the largest hot desert?", a: ["Sahara", "Gobi", "Kalahari", "Arabian"], c: 0, cat: "Geography" },
      { q: "What ocean is the deepest?", a: ["Pacific", "Atlantic", "Indian", "Arctic"], c: 0, cat: "Geography" },
      { q: "Mount Everest is on the border of which two countries?", a: ["Nepal & China", "India & China", "Nepal & India", "Pakistan & China"], c: 0, cat: "Geography" },
      // POP CULTURE (7)
      { q: "What band performed 'Bohemian Rhapsody'?", a: ["Queen", "The Beatles", "Led Zeppelin", "Pink Floyd"], c: 0, cat: "Pop Culture" },
      { q: "What is the highest-grossing film of all time?", a: ["Avatar", "Avengers: Endgame", "Titanic", "Star Wars"], c: 0, cat: "Pop Culture" },
      { q: "Who wrote the Harry Potter series?", a: ["J.K. Rowling", "J.R.R. Tolkien", "Stephen King", "Roald Dahl"], c: 0, cat: "Pop Culture" },
      { q: "What year was the first iPhone released?", a: ["2007", "2005", "2008", "2010"], c: 0, cat: "Pop Culture" },
      { q: "What TV show featured Walter White?", a: ["Breaking Bad", "The Wire", "Lost", "Dexter"], c: 0, cat: "Pop Culture" },
      { q: "Which superhero is also known as Diana Prince?", a: ["Wonder Woman", "Black Widow", "Supergirl", "Batgirl"], c: 0, cat: "Pop Culture" },
      { q: "Who directed Jurassic Park?", a: ["Steven Spielberg", "James Cameron", "George Lucas", "Ridley Scott"], c: 0, cat: "Pop Culture" },
      // SPORTS (7)
      { q: "How many players per side on a soccer field?", a: ["11", "10", "12", "9"], c: 0, cat: "Sports" },
      { q: "What sport is played at Wimbledon?", a: ["Tennis", "Cricket", "Golf", "Polo"], c: 0, cat: "Sports" },
      { q: "How many rings are on the Olympic flag?", a: ["5", "4", "6", "7"], c: 0, cat: "Sports" },
      { q: "What country invented the sport of cricket?", a: ["England", "India", "Australia", "South Africa"], c: 0, cat: "Sports" },
      { q: "In basketball, how many points is a free throw?", a: ["1", "2", "3", "Half a point"], c: 0, cat: "Sports" },
      { q: "What is the marathon distance in miles (approx)?", a: ["26.2", "24.0", "28.5", "30.0"], c: 0, cat: "Sports" },
      { q: "Which country has won the most FIFA World Cups?", a: ["Brazil", "Germany", "Italy", "Argentina"], c: 0, cat: "Sports" },
      // MATH (7)
      { q: "What is Pi to two decimal places?", a: ["3.14", "3.16", "3.12", "3.18"], c: 0, cat: "Math" },
      { q: "What is the square root of 144?", a: ["12", "14", "11", "13"], c: 0, cat: "Math" },
      { q: "How many sides does a hexagon have?", a: ["6", "5", "7", "8"], c: 0, cat: "Math" },
      { q: "What is 17 multiplied by 13?", a: ["221", "231", "211", "219"], c: 0, cat: "Math" },
      { q: "What is a triangle with all equal sides called?", a: ["Equilateral", "Isosceles", "Scalene", "Right"], c: 0, cat: "Math" },
      { q: "What is 2 to the power of 10?", a: ["1024", "1000", "512", "2048"], c: 0, cat: "Math" },
      { q: "How many degrees are in a circle?", a: ["360", "180", "270", "400"], c: 0, cat: "Math" },
      // NATURE (7)
      { q: "What is the largest mammal on Earth?", a: ["Blue whale", "Elephant", "Giraffe", "Hippopotamus"], c: 0, cat: "Nature" },
      { q: "How many hearts does an octopus have?", a: ["3", "2", "1", "4"], c: 0, cat: "Nature" },
      { q: "What is the fastest land animal?", a: ["Cheetah", "Lion", "Gazelle", "Horse"], c: 0, cat: "Nature" },
      { q: "What type of animal is a Komodo dragon?", a: ["Lizard", "Snake", "Crocodile", "Turtle"], c: 0, cat: "Nature" },
      { q: "What is the tallest type of grass?", a: ["Bamboo", "Sugarcane", "Wheat", "Corn"], c: 0, cat: "Nature" },
      { q: "What animal has the longest known lifespan?", a: ["Greenland shark", "Giant tortoise", "Elephant", "Bowhead whale"], c: 0, cat: "Nature" },
      { q: "Which bird can fly backwards?", a: ["Hummingbird", "Kingfisher", "Sparrow", "Swift"], c: 0, cat: "Nature" },
      // TECHNOLOGY (8)
      { q: "What does 'HTTP' stand for?", a: ["HyperText Transfer Protocol", "High Tech Transfer Process", "HyperText Transmission Program", "High Transfer Text Protocol"], c: 0, cat: "Technology" },
      { q: "Who co-founded Apple with Steve Jobs?", a: ["Steve Wozniak", "Bill Gates", "Tim Cook", "Larry Page"], c: 0, cat: "Technology" },
      { q: "What programming language is named after coffee?", a: ["Java", "Python", "Ruby", "Rust"], c: 0, cat: "Technology" },
      { q: "In what decade was the internet invented?", a: ["1960s", "1970s", "1980s", "1990s"], c: 0, cat: "Technology" },
      { q: "What does 'CPU' stand for?", a: ["Central Processing Unit", "Computer Personal Unit", "Central Program Utility", "Core Processing Unit"], c: 0, cat: "Technology" },
      { q: "What company created Android?", a: ["Google", "Apple", "Microsoft", "Samsung"], c: 0, cat: "Technology" },
      { q: "How many bits are in a byte?", a: ["8", "4", "16", "32"], c: 0, cat: "Technology" },
      { q: "What does 'RAM' stand for?", a: ["Random Access Memory", "Read Access Memory", "Rapid Action Memory", "Run Application Memory"], c: 0, cat: "Technology" },
    ];

    // ===== AI OPPONENTS =====
    const aiNames = ["NEXUS", "CIPHER", "BLAZE", "ECHO", "NOVA", "PHANTOM", "VORTEX"];
    const aiAccuracies = [0.90, 0.80, 0.72, 0.65, 0.55, 0.45, 0.40];
    const aiColors = ["#4af", "#f90", "#0f0", "#ff0", "#f44", "#a0f", "#0ff"];

    // ===== GAME STATE =====
    let players = [];
    let currentRound = 0;
    let totalRounds = 25;
    let currentQuestion = null;
    let questionPool = [];
    let timer = 0;
    let timerMax = 15;
    let timerStart = 0;
    let phase = 'idle'; // idle | question | reveal | gameOver
    let playerAnswer = -1;
    let aiAnswers = [];
    let revealTime = 0;
    let eliminatedThisRound = [];
    let hoverChoice = -1;
    let particles = [];
    let shakeAmount = 0;
    let flashAlpha = 0;
    let flashColor = '#fff';
    let pendingReveal = false;
    let nextRoundTimeout = null;

    // Choice button rectangles
    const choiceBoxes = [];
    const CHOICE_X = 50;
    const CHOICE_W = 500;
    const CHOICE_H = 36;
    const CHOICE_Y0 = 262;
    const CHOICE_GAP = 44;
    for (let i = 0; i < 4; i++) {
      choiceBoxes.push({ x: CHOICE_X, y: CHOICE_Y0 + i * CHOICE_GAP, w: CHOICE_W, h: CHOICE_H });
    }

    // Category badge colors
    const catColors = {
      "Science": "#4af", "History": "#f90", "Geography": "#0f0", "Pop Culture": "#f0a",
      "Sports": "#ff0", "Math": "#a0f", "Nature": "#0d8", "Technology": "#0ff"
    };

    // ===== PARTICLES =====
    function spawnParticles(x, y, color, count) {
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 4;
        particles.push({
          x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed,
          life: 1, decay: 0.01 + Math.random() * 0.03, color, size: 2 + Math.random() * 4
        });
      }
    }

    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx; p.y += p.vy; p.vy += 0.05; p.life -= p.decay;
        if (p.life <= 0) particles.splice(i, 1);
      }
    }

    function drawParticles() {
      for (const p of particles) {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 8;
        ctx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
      }
      ctx.globalAlpha = 1; ctx.shadowBlur = 0;
    }

    // ===== AVATARS =====
    const avatarShapes = ['circle', 'diamond', 'square', 'triangle', 'star', 'cross', 'hex', 'shield'];

    function drawAvatar(x, y, player, idx, size) {
      ctx.save();
      if (player.eliminated) ctx.globalAlpha = 0.25;
      ctx.fillStyle = player.color;
      ctx.shadowColor = player.color;
      ctx.shadowBlur = player.eliminated ? 0 : 8;
      const s = size, hs = s / 2;
      const shape = avatarShapes[idx % avatarShapes.length];

      switch (shape) {
        case 'circle':
          ctx.beginPath(); ctx.arc(x, y, hs, 0, Math.PI * 2); ctx.fill(); break;
        case 'diamond':
          ctx.beginPath(); ctx.moveTo(x, y - hs); ctx.lineTo(x + hs, y);
          ctx.lineTo(x, y + hs); ctx.lineTo(x - hs, y); ctx.closePath(); ctx.fill(); break;
        case 'square':
          ctx.fillRect(x - hs, y - hs, s, s); break;
        case 'triangle':
          ctx.beginPath(); ctx.moveTo(x, y - hs); ctx.lineTo(x + hs, y + hs);
          ctx.lineTo(x - hs, y + hs); ctx.closePath(); ctx.fill(); break;
        case 'star': {
          ctx.beginPath();
          for (let i = 0; i < 10; i++) {
            const r = i % 2 === 0 ? hs : hs * 0.45;
            const a = (Math.PI * i) / 5 - Math.PI / 2;
            const px = x + Math.cos(a) * r, py = y + Math.sin(a) * r;
            i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          }
          ctx.closePath(); ctx.fill(); break;
        }
        case 'cross': {
          const t = s / 4;
          ctx.fillRect(x - t, y - hs, t * 2, s);
          ctx.fillRect(x - hs, y - t, s, t * 2); break;
        }
        case 'hex':
          ctx.beginPath();
          for (let i = 0; i < 6; i++) {
            const a = Math.PI / 3 * i - Math.PI / 6;
            const px = x + Math.cos(a) * hs, py = y + Math.sin(a) * hs;
            i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          }
          ctx.closePath(); ctx.fill(); break;
        case 'shield':
          ctx.beginPath(); ctx.moveTo(x - hs, y - s / 3); ctx.lineTo(x + hs, y - s / 3);
          ctx.lineTo(x + hs, y + s / 6); ctx.lineTo(x, y + hs);
          ctx.lineTo(x - hs, y + s / 6); ctx.closePath(); ctx.fill(); break;
      }
      ctx.shadowBlur = 0;
      ctx.restore();
    }

    // ===== PLAYER SLOT POSITIONS =====
    // Top: slots 0-3 | Bottom: slots 4-7
    function slotX(i) {
      const col = i < 4 ? i : (i - 4);
      return 22 + col * 148;
    }
    function slotY(i) { return i < 4 ? 4 : H - 40; }

    function drawPlayerSlots() {
      for (let i = 0; i < players.length; i++) {
        const p = players[i];
        const sx = slotX(i), sy = slotY(i);
        const isTop = i < 4;

        // Avatar
        drawAvatar(sx + 12, sy + 14, p, i, 18);

        // Name
        ctx.font = 'bold 10px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = p.eliminated ? '#444' : p.color;
        if (!p.eliminated) { ctx.shadowColor = p.color; ctx.shadowBlur = 4; }
        ctx.fillText(p.isHuman ? 'YOU' : p.name, sx + 26, sy + 12);
        ctx.shadowBlur = 0;

        // Hearts
        for (let h = 0; h < 3; h++) {
          ctx.fillStyle = h < p.lives ? '#f44' : '#2a2a2a';
          ctx.font = '10px Courier New';
          ctx.fillText('\u2665', sx + 26 + h * 12, sy + 25);
        }

        // Mini score
        ctx.fillStyle = p.eliminated ? '#333' : '#777';
        ctx.font = '9px Courier New';
        ctx.fillText(p.score + 'pt', sx + 65, sy + 25);

        // Elimination cross
        if (p.eliminated) {
          ctx.save();
          ctx.strokeStyle = '#f00'; ctx.lineWidth = 2.5; ctx.globalAlpha = 0.55;
          ctx.beginPath();
          ctx.moveTo(sx + 2, sy + 3); ctx.lineTo(sx + 22, sy + 25);
          ctx.moveTo(sx + 22, sy + 3); ctx.lineTo(sx + 2, sy + 25);
          ctx.stroke();
          ctx.restore();
        }

        // Answer indicator during reveal
        if (phase === 'reveal') {
          let ans = p.isHuman ? playerAnswer : (aiAnswers[i - 1] ? aiAnswers[i - 1].choice : -1);
          if (!p.eliminated || eliminatedThisRound.includes(p)) {
            if (ans >= 0) {
              const correct = ans === currentQuestion.c;
              ctx.font = 'bold 13px Courier New';
              ctx.fillStyle = correct ? '#0f0' : '#f00';
              ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 6;
              ctx.fillText(correct ? '\u2713' : '\u2717', sx + 1, sy + 16);
              ctx.shadowBlur = 0;
            } else if (!p.eliminated || eliminatedThisRound.includes(p)) {
              // Timeout indicator
              ctx.font = 'bold 11px Courier New';
              ctx.fillStyle = '#f00';
              ctx.fillText('T', sx + 1, sy + 16);
            }
          }
        }
      }
    }

    // ===== INIT GAME =====
    function initGame() {
      score = 0;
      scoreEl.textContent = '0';
      currentRound = 0;
      playerAnswer = -1;
      phase = 'idle';
      particles = [];
      eliminatedThisRound = [];
      if (nextRoundTimeout) clearTimeout(nextRoundTimeout);

      // Shuffle question pool
      questionPool = [...questions];
      for (let i = questionPool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questionPool[i], questionPool[j]] = [questionPool[j], questionPool[i]];
      }

      // Create 8 players: YOU + 7 AI
      players = [{
        name: "YOU", lives: 3, score: 0, isHuman: true, color: "#f0a",
        accuracy: 1, eliminated: false, eliminatedRound: -1, answerTime: 0
      }];
      for (let i = 0; i < 7; i++) {
        players.push({
          name: aiNames[i], lives: 3, score: 0, isHuman: false, color: aiColors[i],
          accuracy: aiAccuracies[i], eliminated: false, eliminatedRound: -1, answerTime: 0
        });
      }

      startRound();
    }

    // ===== ROUND LOGIC =====
    function countAlive() { return players.filter(p => !p.eliminated).length; }

    function startRound() {
      if (currentRound >= totalRounds || countAlive() <= 1) { endGame(); return; }

      currentQuestion = questionPool[currentRound % questionPool.length];
      playerAnswer = -1;
      aiAnswers = [];
      eliminatedThisRound = [];
      timer = timerMax;
      timerStart = Date.now();
      phase = 'question';
      pendingReveal = false;
      currentRound++;

      // Pre-compute AI decisions
      for (let i = 0; i < 7; i++) {
        const p = players[i + 1];
        if (p.eliminated) { aiAnswers.push({ choice: -1, time: 0 }); continue; }

        const correct = Math.random() < p.accuracy;
        let choice;
        if (correct) {
          choice = currentQuestion.c;
        } else {
          const wrongs = [0, 1, 2, 3].filter(x => x !== currentQuestion.c);
          choice = wrongs[Math.floor(Math.random() * wrongs.length)];
        }
        // Smarter AIs answer faster on average
        const t = 2 + (1 - p.accuracy) * 8 + Math.random() * 3;
        aiAnswers.push({ choice, time: Math.min(t, timerMax - 0.5) });
      }
    }

    function submitAnswer(choice) {
      if (phase !== 'question' || playerAnswer !== -1 || players[0].eliminated) return;
      playerAnswer = choice;
      players[0].answerTime = (Date.now() - timerStart) / 1000;
    }

    function revealAnswers() {
      if (phase !== 'question') return;
      phase = 'reveal';
      revealTime = Date.now();

      const correctIdx = currentQuestion.c;

      // --- Human ---
      if (!players[0].eliminated) {
        if (playerAnswer === correctIdx) {
          const timeBonus = Math.max(0, Math.floor((timerMax - players[0].answerTime) * 10));
          players[0].score += 100 + timeBonus;
          score = players[0].score;
          scoreEl.textContent = score;
          spawnParticles(300, 230, '#0f0', 25);
          flashAlpha = 0.15; flashColor = '#0f0';
        } else {
          players[0].lives--;
          shakeAmount = 12;
          flashAlpha = 0.35; flashColor = '#f00';
          if (players[0].lives <= 0) {
            players[0].eliminated = true;
            players[0].eliminatedRound = currentRound;
            eliminatedThisRound.push(players[0]);
            spawnParticles(slotX(0) + 12, slotY(0) + 14, '#f00', 40);
          }
        }
      }

      // --- AI ---
      for (let i = 0; i < 7; i++) {
        const p = players[i + 1];
        if (p.eliminated) continue;
        const ai = aiAnswers[i];
        if (ai.choice === correctIdx) {
          const timeBonus = Math.max(0, Math.floor((timerMax - ai.time) * 10));
          p.score += 100 + timeBonus;
        } else {
          p.lives--;
          if (p.lives <= 0) {
            p.eliminated = true;
            p.eliminatedRound = currentRound;
            eliminatedThisRound.push(p);
            spawnParticles(slotX(i + 1) + 12, slotY(i + 1) + 14, '#f00', 30);
          }
        }
      }

      // Schedule next round or end
      const alive = countAlive();
      const delay = eliminatedThisRound.length > 0 ? 3000 : 2200;
      if (alive <= 1 || currentRound >= totalRounds) {
        nextRoundTimeout = setTimeout(() => endGame(), delay);
      } else {
        nextRoundTimeout = setTimeout(() => startRound(), delay);
      }
    }

    function endGame() {
      phase = 'gameOver';
      gameState = 'over';

      // Survival bonus for living players
      for (const p of players) {
        if (!p.eliminated) p.score += 500;
      }
      score = players[0].score;
      scoreEl.textContent = score;

      if (score > bestScore) {
        bestScore = score;
        bestEl.textContent = bestScore;
        localStorage.setItem('triviaRoyaleBest', String(bestScore));
      }

      // Determine winner
      const alive = players.filter(p => !p.eliminated);
      let winner;
      if (alive.length === 1) winner = alive[0];
      else if (alive.length > 1) winner = alive.sort((a, b) => b.score - a.score)[0];
      else winner = [...players].sort((a, b) => b.eliminatedRound - a.eliminatedRound)[0];

      if (winner.isHuman) {
        overlayTitle.textContent = 'VICTORY ROYALE!';
        overlayText.textContent = 'You won with ' + score + ' points! Click to play again.';
        spawnParticles(W / 2, H / 2, '#f0a', 60);
        spawnParticles(W / 2, H / 2, '#ff0', 40);
      } else {
        overlayTitle.textContent = 'ELIMINATED';
        overlayText.textContent = winner.name + ' wins! Your score: ' + score + '. Click to play again.';
      }
      overlay.style.display = 'flex';
    }

    // ===== DRAWING =====
    function wrapText(text, maxW) {
      const words = text.split(' ');
      const lines = []; let cur = '';
      for (const w of words) {
        const test = cur ? cur + ' ' + w : w;
        if (ctx.measureText(test).width > maxW) { if (cur) lines.push(cur); cur = w; }
        else cur = test;
      }
      if (cur) lines.push(cur);
      return lines;
    }

    function drawTimerBar() {
      const elapsed = (Date.now() - timerStart) / 1000;
      timer = Math.max(0, timerMax - elapsed);
      const pct = timer / timerMax;

      const barX = 50, barY = 50, barW = 480, barH = 8;
      ctx.fillStyle = '#181830';
      ctx.fillRect(barX, barY, barW, barH);

      let col = pct > 0.5 ? '#0f0' : pct > 0.25 ? '#ff0' : '#f00';
      ctx.fillStyle = col;
      ctx.shadowColor = col;
      ctx.shadowBlur = pct < 0.25 ? 14 : 4;
      ctx.fillRect(barX, barY, barW * pct, barH);
      ctx.shadowBlur = 0;

      // Pulsing urgency when low
      if (pct < 0.25 && phase === 'question') {
        ctx.globalAlpha = 0.08 + 0.06 * Math.sin(Date.now() / 100);
        ctx.fillStyle = '#f00';
        ctx.fillRect(0, 0, W, H);
        ctx.globalAlpha = 1;
      }

      ctx.font = 'bold 13px Courier New';
      ctx.textAlign = 'right';
      ctx.fillStyle = col;
      ctx.fillText(Math.ceil(timer) + 's', barX + barW + 48, barY + 9);
      ctx.textAlign = 'left';
    }

    function drawQuestionText() {
      if (!currentQuestion) return;
      const catCol = catColors[currentQuestion.cat] || '#f0a';

      // Category + round
      ctx.font = 'bold 11px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = catCol;
      ctx.shadowColor = catCol; ctx.shadowBlur = 6;
      ctx.fillText('[ ' + currentQuestion.cat.toUpperCase() + ' ]   Round ' + currentRound + '/' + totalRounds, W / 2, 78);
      ctx.shadowBlur = 0;

      // Question
      ctx.font = 'bold 16px Courier New';
      ctx.fillStyle = '#fff';
      const lines = wrapText(currentQuestion.q, W - 120);
      for (let i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], W / 2, 108 + i * 22);
      }

      // Alive count
      ctx.font = '11px Courier New';
      ctx.fillStyle = '#666';
      const alive = countAlive();
      ctx.fillText(alive + ' player' + (alive !== 1 ? 's' : '') + ' remaining', W / 2, 108 + lines.length * 22 + 16);
    }

    function drawChoices() {
      if (!currentQuestion) return;
      const correctIdx = currentQuestion.c;
      const labels = ['A', 'B', 'C', 'D'];

      for (let i = 0; i < 4; i++) {
        const box = choiceBoxes[i];
        let bg = '#1c1c38', border = '#3a3a5a', txt = '#ddd', glow = 0;

        if (phase === 'reveal') {
          if (i === correctIdx) {
            bg = '#0a3a0a'; border = '#0f0'; txt = '#0f0'; glow = 12;
          } else if (i === playerAnswer && i !== correctIdx) {
            bg = '#3a0a0a'; border = '#f00'; txt = '#f44'; glow = 12;
          } else {
            bg = '#141425'; border = '#282840'; txt = '#444';
          }
        } else if (phase === 'question') {
          if (i === playerAnswer) {
            bg = '#2a1a3a'; border = '#f0a'; txt = '#f0a'; glow = 8;
          } else if (i === hoverChoice && playerAnswer === -1) {
            bg = '#222244'; border = '#888'; txt = '#fff'; glow = 3;
          }
        }

        // Background
        ctx.fillStyle = bg;
        if (glow > 0) { ctx.shadowColor = border; ctx.shadowBlur = glow; }
        ctx.fillRect(box.x, box.y, box.w, box.h);
        ctx.shadowBlur = 0;

        // Border
        ctx.strokeStyle = border; ctx.lineWidth = 2;
        ctx.strokeRect(box.x, box.y, box.w, box.h);

        // Label badge
        ctx.fillStyle = border;
        ctx.fillRect(box.x, box.y, 30, box.h);
        ctx.font = 'bold 15px Courier New';
        ctx.textAlign = 'center';
        ctx.fillStyle = bg;
        ctx.fillText(labels[i], box.x + 15, box.y + box.h / 2 + 5);

        // Answer text
        ctx.font = '14px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = txt;
        ctx.fillText(currentQuestion.a[i], box.x + 42, box.y + box.h / 2 + 5);
      }
    }

    function drawEliminationBanner() {
      if (eliminatedThisRound.length === 0 || phase !== 'reveal') return;
      const elapsed = (Date.now() - revealTime) / 1000;
      if (elapsed < 0.6 || elapsed > 2.6) return;

      const alpha = elapsed < 1.0 ? (elapsed - 0.6) / 0.4 : Math.max(0, 1 - (elapsed - 2.0) / 0.6);
      ctx.save();
      ctx.globalAlpha = alpha;

      // Dark band
      ctx.fillStyle = 'rgba(80, 0, 0, 0.9)';
      ctx.fillRect(0, 208, W, 44);

      // Skull/X deco
      ctx.font = 'bold 20px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#f44';
      ctx.shadowColor = '#f00'; ctx.shadowBlur = 15;

      const names = eliminatedThisRound.map(p => p.isHuman ? 'YOU' : p.name).join(', ');
      ctx.fillText('\u2620 ELIMINATED: ' + names + ' \u2620', W / 2, 236);

      ctx.shadowBlur = 0;
      ctx.restore();
    }

    function drawFinalStandings() {
      // Title
      ctx.font = 'bold 22px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#f0a';
      ctx.shadowColor = '#f0a'; ctx.shadowBlur = 15;
      ctx.fillText('FINAL STANDINGS', W / 2, 72);
      ctx.shadowBlur = 0;

      // Sort: alive first by score, then eliminated by round desc
      const sorted = [...players].sort((a, b) => {
        if (a.eliminated !== b.eliminated) return a.eliminated ? 1 : -1;
        if (!a.eliminated && !b.eliminated) return b.score - a.score;
        return b.eliminatedRound - a.eliminatedRound;
      });

      const medalColors = ['#fd0', '#ccc', '#c84'];

      for (let i = 0; i < sorted.length; i++) {
        const p = sorted[i];
        const y = 102 + i * 36;
        const rank = i + 1;

        // Rank
        ctx.font = 'bold 15px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = rank <= 3 ? medalColors[rank - 1] : '#555';
        if (rank <= 3) { ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 6; }
        ctx.fillText('#' + rank, 80, y);
        ctx.shadowBlur = 0;

        // Avatar
        const pidx = players.indexOf(p);
        drawAvatar(128, y - 5, p, pidx, 14);

        // Name (highlight human)
        ctx.font = p.isHuman ? 'bold 14px Courier New' : '14px Courier New';
        ctx.fillStyle = p.eliminated ? '#555' : p.color;
        if (p.isHuman && !p.eliminated) { ctx.shadowColor = p.color; ctx.shadowBlur = 6; }
        ctx.fillText(p.isHuman ? 'YOU' : p.name, 148, y);
        ctx.shadowBlur = 0;

        // Score
        ctx.textAlign = 'right';
        ctx.font = '14px Courier New';
        ctx.fillStyle = p.eliminated ? '#444' : '#fff';
        ctx.fillText(p.score + ' pts', 410, y);

        // Status
        ctx.font = '11px Courier New';
        if (p.eliminated) {
          ctx.fillStyle = '#f44';
          ctx.fillText('OUT R' + p.eliminatedRound, 510, y);
        } else {
          ctx.fillStyle = '#0f0';
          ctx.shadowColor = '#0f0'; ctx.shadowBlur = 4;
          ctx.fillText('SURVIVED', 510, y);
          ctx.shadowBlur = 0;
        }
        ctx.textAlign = 'left';
      }
    }

    function drawScreenFx() {
      if (shakeAmount > 0) { shakeAmount *= 0.88; if (shakeAmount < 0.5) shakeAmount = 0; }
      if (flashAlpha > 0) {
        ctx.globalAlpha = flashAlpha;
        ctx.fillStyle = flashColor;
        ctx.fillRect(0, 0, W, H);
        ctx.globalAlpha = 1;
        flashAlpha *= 0.9;
        if (flashAlpha < 0.01) flashAlpha = 0;
      }
    }

    function draw() {
      ctx.save();
      if (shakeAmount > 0) {
        ctx.translate((Math.random() - 0.5) * shakeAmount, (Math.random() - 0.5) * shakeAmount);
      }

      // Background
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, W, H);

      // Vignette
      const vg = ctx.createRadialGradient(W / 2, H / 2, 80, W / 2, H / 2, 420);
      vg.addColorStop(0, 'transparent');
      vg.addColorStop(1, 'rgba(0,0,0,0.45)');
      ctx.fillStyle = vg;
      ctx.fillRect(0, 0, W, H);

      if (phase === 'question' || phase === 'reveal') {
        // Divider lines between player slots and main area
        ctx.strokeStyle = '#252545'; ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, 42); ctx.lineTo(W, 42);
        ctx.moveTo(0, H - 42); ctx.lineTo(W, H - 42);
        ctx.stroke();

        drawPlayerSlots();
        drawTimerBar();
        drawQuestionText();
        drawChoices();
        drawEliminationBanner();
        drawParticles();
        drawScreenFx();
      } else if (phase === 'gameOver') {
        drawPlayerSlots();
        drawFinalStandings();
        drawParticles();
      }

      ctx.restore();
    }

    // ===== UPDATE (separated from draw) =====
    function update() {
      if (phase === 'question') {
        const elapsed = (Date.now() - timerStart) / 1000;
        timer = Math.max(0, timerMax - elapsed);
        if (timer <= 0 && !pendingReveal) {
          pendingReveal = true;
          revealAnswers();
        }
      }
    }

    // ===== INPUT =====
    canvas.addEventListener('mousemove', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (W / rect.width);
      const my = (e.clientY - rect.top) * (H / rect.height);
      hoverChoice = -1;
      if (phase !== 'question' || playerAnswer !== -1) return;
      for (let i = 0; i < 4; i++) {
        const b = choiceBoxes[i];
        if (mx >= b.x && mx <= b.x + b.w && my >= b.y && my <= b.y + b.h) { hoverChoice = i; break; }
      }
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (W / rect.width);
      const my = (e.clientY - rect.top) * (H / rect.height);
      if (phase === 'question') {
        for (let i = 0; i < 4; i++) {
          const b = choiceBoxes[i];
          if (mx >= b.x && mx <= b.x + b.w && my >= b.y && my <= b.y + b.h) { submitAnswer(i); break; }
        }
      }
    });

    // Overlay click to start/restart
    overlay.parentElement.addEventListener('click', () => {
      if (gameState === 'waiting') {
        gameState = 'playing';
        overlay.style.display = 'none';
        initGame();
      } else if (gameState === 'over') {
        gameState = 'playing';
        overlay.style.display = 'none';
        initGame();
      }
    });

    // ===== MAIN LOOP =====
    function gameLoop() {
      if (gameState === 'playing') {
        update();
        updateParticles();
        draw();
      }
      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
  <script src="../recorder.js?v=2"></script>
</body>
</html>
