<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia Royale</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      width: 600px;
    }
    .back { color: #f0a; text-decoration: none; font-size: 1.2rem; }
    .back:hover { text-shadow: 0 0 10px rgba(255, 0, 170, 0.5); }
    h1 { color: #f0a; font-size: 1.6rem; text-shadow: 0 0 15px rgba(255, 0, 170, 0.4); }
    .score-bar {
      display: flex;
      justify-content: space-between;
      width: 600px;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .score-bar span { color: #f0a; }
    canvas {
      border: 2px solid #f0a;
      box-shadow: 0 0 20px rgba(255, 0, 170, 0.2);
      display: block;
      cursor: pointer;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #f0a;
      text-align: center;
      pointer-events: none;
      background: rgba(26, 26, 46, 0.85);
    }
    .overlay h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .overlay p { font-size: 1rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" class="back">&larr; Back</a>
    <h1>TRIVIA ROYALE</h1>
  </div>
  <div class="score-bar">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div style="position: relative; display: inline-block;">
    <canvas id="game" width="600" height="500"></canvas>
    <div class="overlay" id="overlay" style="width:600px;height:500px;">
      <h2 id="overlayTitle">TRIVIA ROYALE</h2>
      <p id="overlayText">Click to Start</p>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = 600, H = 500;
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');

    let gameState = 'waiting';
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('triviaRoyaleBest') || '0');
    bestEl.textContent = bestScore;

    // ===== QUESTION BANK (60 questions across 8 categories) =====
    const questions = [
      // SCIENCE
      { q: "What planet is known as the Red Planet?", a: ["Mars", "Venus", "Jupiter", "Saturn"], c: 0, cat: "Science" },
      { q: "What is the chemical symbol for gold?", a: ["Au", "Ag", "Fe", "Cu"], c: 0, cat: "Science" },
      { q: "How many bones are in the adult human body?", a: ["206", "186", "226", "196"], c: 0, cat: "Science" },
      { q: "What gas do plants absorb from the atmosphere?", a: ["Carbon dioxide", "Oxygen", "Nitrogen", "Hydrogen"], c: 0, cat: "Science" },
      { q: "What is the speed of light in km/s (approx)?", a: ["300,000", "150,000", "500,000", "1,000,000"], c: 0, cat: "Science" },
      { q: "What is the hardest natural substance?", a: ["Diamond", "Quartz", "Topaz", "Sapphire"], c: 0, cat: "Science" },
      { q: "What organ produces insulin?", a: ["Pancreas", "Liver", "Kidney", "Stomach"], c: 0, cat: "Science" },
      // HISTORY
      { q: "In what year did World War II end?", a: ["1945", "1944", "1946", "1943"], c: 0, cat: "History" },
      { q: "Who was the first President of the United States?", a: ["George Washington", "John Adams", "Thomas Jefferson", "Ben Franklin"], c: 0, cat: "History" },
      { q: "The Great Wall of China was primarily built to defend against whom?", a: ["Mongols", "Japanese", "Koreans", "Russians"], c: 0, cat: "History" },
      { q: "What ancient wonder was located in Alexandria?", a: ["Lighthouse", "Colossus", "Hanging Gardens", "Temple of Artemis"], c: 0, cat: "History" },
      { q: "Which empire was ruled by Genghis Khan?", a: ["Mongol Empire", "Ottoman Empire", "Roman Empire", "Persian Empire"], c: 0, cat: "History" },
      { q: "In what year did the Titanic sink?", a: ["1912", "1905", "1918", "1920"], c: 0, cat: "History" },
      { q: "Who painted the Mona Lisa?", a: ["Leonardo da Vinci", "Michelangelo", "Raphael", "Donatello"], c: 0, cat: "History" },
      // GEOGRAPHY
      { q: "What is the largest continent by area?", a: ["Asia", "Africa", "North America", "Europe"], c: 0, cat: "Geography" },
      { q: "What is the longest river in the world?", a: ["Nile", "Amazon", "Mississippi", "Yangtze"], c: 0, cat: "Geography" },
      { q: "Which country has the most time zones?", a: ["France", "Russia", "USA", "China"], c: 0, cat: "Geography" },
      { q: "What is the capital of Australia?", a: ["Canberra", "Sydney", "Melbourne", "Brisbane"], c: 0, cat: "Geography" },
      { q: "What is the smallest country in the world?", a: ["Vatican City", "Monaco", "San Marino", "Liechtenstein"], c: 0, cat: "Geography" },
      { q: "Which desert is the largest in the world?", a: ["Sahara", "Gobi", "Kalahari", "Atacama"], c: 0, cat: "Geography" },
      { q: "What ocean is the deepest?", a: ["Pacific", "Atlantic", "Indian", "Arctic"], c: 0, cat: "Geography" },
      // POP CULTURE
      { q: "What band performed 'Bohemian Rhapsody'?", a: ["Queen", "The Beatles", "Led Zeppelin", "Pink Floyd"], c: 0, cat: "Pop Culture" },
      { q: "What is the highest-grossing film of all time (unadjusted)?", a: ["Avatar", "Avengers: Endgame", "Titanic", "Star Wars"], c: 0, cat: "Pop Culture" },
      { q: "Who wrote the Harry Potter series?", a: ["J.K. Rowling", "J.R.R. Tolkien", "Stephen King", "Roald Dahl"], c: 0, cat: "Pop Culture" },
      { q: "What year was the first iPhone released?", a: ["2007", "2005", "2008", "2010"], c: 0, cat: "Pop Culture" },
      { q: "What TV show featured a character named Walter White?", a: ["Breaking Bad", "The Wire", "Lost", "Dexter"], c: 0, cat: "Pop Culture" },
      { q: "Which superhero is also known as Diana Prince?", a: ["Wonder Woman", "Black Widow", "Supergirl", "Batgirl"], c: 0, cat: "Pop Culture" },
      { q: "Who directed Jurassic Park?", a: ["Steven Spielberg", "James Cameron", "George Lucas", "Ridley Scott"], c: 0, cat: "Pop Culture" },
      // SPORTS
      { q: "How many players are on a soccer team on the field?", a: ["11", "10", "12", "9"], c: 0, cat: "Sports" },
      { q: "What sport is played at Wimbledon?", a: ["Tennis", "Cricket", "Golf", "Polo"], c: 0, cat: "Sports" },
      { q: "How many rings are on the Olympic flag?", a: ["5", "4", "6", "7"], c: 0, cat: "Sports" },
      { q: "What country invented the sport of cricket?", a: ["England", "India", "Australia", "South Africa"], c: 0, cat: "Sports" },
      { q: "In basketball, how many points is a free throw worth?", a: ["1", "2", "3", "0.5"], c: 0, cat: "Sports" },
      { q: "What is the marathon distance in miles (approx)?", a: ["26.2", "24.0", "28.5", "30.0"], c: 0, cat: "Sports" },
      { q: "Which country has won the most FIFA World Cups?", a: ["Brazil", "Germany", "Italy", "Argentina"], c: 0, cat: "Sports" },
      // MATH
      { q: "What is the value of Pi to two decimal places?", a: ["3.14", "3.16", "3.12", "3.18"], c: 0, cat: "Math" },
      { q: "What is the square root of 144?", a: ["12", "14", "11", "13"], c: 0, cat: "Math" },
      { q: "How many sides does a hexagon have?", a: ["6", "5", "7", "8"], c: 0, cat: "Math" },
      { q: "What is 17 x 13?", a: ["221", "231", "211", "219"], c: 0, cat: "Math" },
      { q: "What is a triangle with all equal sides called?", a: ["Equilateral", "Isosceles", "Scalene", "Right"], c: 0, cat: "Math" },
      { q: "What is 2 to the power of 10?", a: ["1024", "1000", "512", "2048"], c: 0, cat: "Math" },
      { q: "How many degrees in a circle?", a: ["360", "180", "270", "400"], c: 0, cat: "Math" },
      // NATURE
      { q: "What is the largest mammal on Earth?", a: ["Blue Whale", "Elephant", "Giraffe", "Hippopotamus"], c: 0, cat: "Nature" },
      { q: "How many hearts does an octopus have?", a: ["3", "2", "1", "4"], c: 0, cat: "Nature" },
      { q: "What is the fastest land animal?", a: ["Cheetah", "Lion", "Gazelle", "Horse"], c: 0, cat: "Nature" },
      { q: "What type of animal is a Komodo dragon?", a: ["Lizard", "Snake", "Crocodile", "Dinosaur"], c: 0, cat: "Nature" },
      { q: "What is the tallest type of grass?", a: ["Bamboo", "Sugarcane", "Wheat", "Corn"], c: 0, cat: "Nature" },
      { q: "How long can a crocodile hold its breath?", a: ["1-2 hours", "10 minutes", "30 minutes", "5 hours"], c: 0, cat: "Nature" },
      { q: "What animal has the longest lifespan?", a: ["Greenland Shark", "Tortoise", "Elephant", "Parrot"], c: 0, cat: "Nature" },
      // TECHNOLOGY
      { q: "What does 'HTTP' stand for?", a: ["HyperText Transfer Protocol", "High Tech Transfer Process", "HyperText Transmission Program", "High Transfer Text Protocol"], c: 0, cat: "Technology" },
      { q: "Who co-founded Apple with Steve Jobs?", a: ["Steve Wozniak", "Bill Gates", "Tim Cook", "Larry Page"], c: 0, cat: "Technology" },
      { q: "What programming language is named after a coffee?", a: ["Java", "Python", "Ruby", "Rust"], c: 0, cat: "Technology" },
      { q: "In what decade was the internet invented?", a: ["1960s", "1970s", "1980s", "1990s"], c: 0, cat: "Technology" },
      { q: "What does 'CPU' stand for?", a: ["Central Processing Unit", "Computer Personal Unit", "Central Program Utility", "Core Processing Unit"], c: 0, cat: "Technology" },
      { q: "What company created Android?", a: ["Google", "Apple", "Microsoft", "Samsung"], c: 0, cat: "Technology" },
      { q: "How many bits are in a byte?", a: ["8", "4", "16", "32"], c: 0, cat: "Technology" },
      { q: "What was the first search engine on the internet?", a: ["Archie", "Google", "Yahoo", "AltaVista"], c: 0, cat: "Technology" },
      { q: "What does 'RAM' stand for?", a: ["Random Access Memory", "Read Access Memory", "Rapid Action Memory", "Run Application Memory"], c: 0, cat: "Technology" },
      { q: "What year was YouTube founded?", a: ["2005", "2003", "2007", "2006"], c: 0, cat: "Technology" },
    ];

    // ===== AI PLAYERS =====
    const aiNames = ["NEXUS", "CIPHER", "BLAZE", "ECHO", "NOVA", "PHANTOM", "VORTEX"];
    const aiAccuracies = [0.90, 0.80, 0.72, 0.65, 0.55, 0.45, 0.40];
    const aiColors = ["#4af", "#f90", "#0f0", "#ff0", "#f44", "#a0f", "#0ff"];

    // ===== GAME VARIABLES =====
    let players = [];
    let currentRound = 0;
    let totalRounds = 25;
    let currentQuestion = null;
    let questionPool = [];
    let timer = 0;
    let timerMax = 15;
    let timerStart = 0;
    let phase = 'idle'; // idle, question, reveal, eliminated, roundEnd, gameOver
    let playerAnswer = -1;
    let aiAnswers = [];
    let revealTime = 0;
    let eliminatedThisRound = [];
    let hoverChoice = -1;
    let particles = [];
    let shakeAmount = 0;
    let flashAlpha = 0;
    let flashColor = '#fff';

    // Choice button geometry
    const choiceBoxes = [];
    const CHOICE_X = 50;
    const CHOICE_W = 500;
    const CHOICE_H = 36;
    const CHOICE_Y_START = 260;
    const CHOICE_GAP = 44;

    for (let i = 0; i < 4; i++) {
      choiceBoxes.push({
        x: CHOICE_X,
        y: CHOICE_Y_START + i * CHOICE_GAP,
        w: CHOICE_W,
        h: CHOICE_H
      });
    }

    // Category colors
    const catColors = {
      "Science": "#4af",
      "History": "#f90",
      "Geography": "#0f0",
      "Pop Culture": "#f0a",
      "Sports": "#ff0",
      "Math": "#a0f",
      "Nature": "#0d8",
      "Technology": "#0ff"
    };

    // ===== PARTICLE SYSTEM =====
    function spawnParticles(x, y, color, count) {
      for (let i = 0; i < count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 4;
        particles.push({
          x, y,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: 1,
          decay: 0.01 + Math.random() * 0.03,
          color,
          size: 2 + Math.random() * 4
        });
      }
    }

    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.05;
        p.life -= p.decay;
        if (p.life <= 0) particles.splice(i, 1);
      }
    }

    function drawParticles() {
      for (const p of particles) {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 8;
        ctx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
      }
      ctx.globalAlpha = 1;
      ctx.shadowBlur = 0;
    }

    // ===== INIT =====
    function initGame() {
      score = 0;
      scoreEl.textContent = '0';
      currentRound = 0;
      playerAnswer = -1;
      phase = 'idle';
      particles = [];
      eliminatedThisRound = [];

      // Shuffle questions
      questionPool = [...questions];
      for (let i = questionPool.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [questionPool[i], questionPool[j]] = [questionPool[j], questionPool[i]];
      }

      // Create players: human + 7 AI
      players = [];
      players.push({
        name: "YOU",
        lives: 3,
        score: 0,
        isHuman: true,
        color: "#f0a",
        accuracy: 1, // irrelevant for human
        eliminated: false,
        eliminatedRound: -1,
        answerTime: 0,
        avatar: generateAvatar(0)
      });
      for (let i = 0; i < 7; i++) {
        players.push({
          name: aiNames[i],
          lives: 3,
          score: 0,
          isHuman: false,
          color: aiColors[i],
          accuracy: aiAccuracies[i],
          eliminated: false,
          eliminatedRound: -1,
          answerTime: 0,
          avatar: generateAvatar(i + 1)
        });
      }

      startRound();
    }

    // Simple avatar: each player gets a unique shape pattern
    function generateAvatar(index) {
      const shapes = ['circle', 'diamond', 'square', 'triangle', 'star', 'cross', 'hex', 'shield'];
      return shapes[index % shapes.length];
    }

    // ===== ROUND LOGIC =====
    function startRound() {
      if (currentRound >= totalRounds || countAlive() <= 1) {
        endGame();
        return;
      }

      currentQuestion = questionPool[currentRound % questionPool.length];
      playerAnswer = -1;
      aiAnswers = [];
      eliminatedThisRound = [];
      timer = timerMax;
      timerStart = Date.now();
      phase = 'question';

      // AI decides answers
      for (let i = 1; i < players.length; i++) {
        const p = players[i];
        if (p.eliminated) {
          aiAnswers.push({ choice: -1, time: 0 });
          continue;
        }
        const correct = Math.random() < p.accuracy;
        let choice;
        if (correct) {
          choice = currentQuestion.c;
        } else {
          // Pick a random wrong answer
          const wrongs = [0, 1, 2, 3].filter(x => x !== currentQuestion.c);
          choice = wrongs[Math.floor(Math.random() * wrongs.length)];
        }
        // AI answer time: 2-12 seconds, smarter AIs tend faster
        const baseTime = 2 + (1 - p.accuracy) * 8 + Math.random() * 3;
        aiAnswers.push({ choice, time: Math.min(baseTime, timerMax - 0.5) });
      }

      currentRound++;
    }

    function countAlive() {
      return players.filter(p => !p.eliminated).length;
    }

    function countAliveAI() {
      return players.filter(p => !p.eliminated && !p.isHuman).length;
    }

    function submitAnswer(choice) {
      if (phase !== 'question' || playerAnswer !== -1) return;
      if (players[0].eliminated) return;
      playerAnswer = choice;
      players[0].answerTime = (Date.now() - timerStart) / 1000;
    }

    function revealAnswers() {
      phase = 'reveal';
      revealTime = Date.now();

      const correctIdx = currentQuestion.c;

      // Process human answer
      if (!players[0].eliminated) {
        if (playerAnswer === correctIdx) {
          const timeBonus = Math.max(0, Math.floor((timerMax - players[0].answerTime) * 10));
          const pts = 100 + timeBonus;
          players[0].score += pts;
          score = players[0].score;
          scoreEl.textContent = score;
          spawnParticles(300, 240, '#0f0', 20);
        } else {
          players[0].lives--;
          shakeAmount = 10;
          flashAlpha = 0.4;
          flashColor = '#f00';
          if (players[0].lives <= 0) {
            players[0].eliminated = true;
            players[0].eliminatedRound = currentRound;
            eliminatedThisRound.push(players[0]);
            spawnParticles(getPlayerSlotX(0), getPlayerSlotY(0), '#f00', 40);
          }
        }
      }

      // Process AI answers
      for (let i = 1; i < players.length; i++) {
        const p = players[i];
        if (p.eliminated) continue;
        const ai = aiAnswers[i - 1];
        if (ai.choice === correctIdx) {
          const timeBonus = Math.max(0, Math.floor((timerMax - ai.time) * 10));
          p.score += 100 + timeBonus;
        } else {
          p.lives--;
          if (p.lives <= 0) {
            p.eliminated = true;
            p.eliminatedRound = currentRound;
            eliminatedThisRound.push(p);
            spawnParticles(getPlayerSlotX(i), getPlayerSlotY(i), '#f00', 30);
          }
        }
      }

      // Check if game should end
      if (countAlive() <= 1 || (players[0].eliminated && countAliveAI() === 0)) {
        setTimeout(() => endGame(), 2500);
      } else {
        setTimeout(() => startRound(), 2500);
      }
    }

    function endGame() {
      phase = 'gameOver';
      gameState = 'over';

      // Survival bonus
      if (!players[0].eliminated) {
        const survivalBonus = 500;
        players[0].score += survivalBonus;
        score = players[0].score;
        scoreEl.textContent = score;
      }

      if (score > bestScore) {
        bestScore = score;
        bestEl.textContent = bestScore;
        localStorage.setItem('triviaRoyaleBest', bestScore);
      }

      // Determine winner
      const alive = players.filter(p => !p.eliminated);
      let winner;
      if (alive.length === 1) {
        winner = alive[0];
      } else if (alive.length > 1) {
        winner = alive.sort((a, b) => b.score - a.score)[0];
      } else {
        // All eliminated: last one standing longest
        winner = [...players].sort((a, b) => b.eliminatedRound - a.eliminatedRound)[0];
      }

      const isPlayerWin = winner.isHuman;
      overlayTitle.textContent = isPlayerWin ? 'VICTORY ROYALE!' : 'ELIMINATED';
      overlayText.textContent = isPlayerWin
        ? `You won with ${score} points! Click to play again`
        : `${winner.name} wins! Your score: ${score}. Click to play again`;
      overlay.style.display = 'flex';
    }

    // ===== PLAYER SLOT POSITIONS (around edges) =====
    function getPlayerSlotX(idx) {
      // Top row: 0-3, Bottom row: 4-7
      if (idx < 4) return 30 + idx * 152;
      return 30 + (idx - 4) * 152;
    }

    function getPlayerSlotY(idx) {
      if (idx < 4) return 20;
      return H - 55;
    }

    // ===== DRAWING =====
    function drawAvatar(x, y, player, size) {
      const s = size;
      ctx.save();
      if (player.eliminated) {
        ctx.globalAlpha = 0.3;
      }
      ctx.fillStyle = player.color;
      ctx.shadowColor = player.color;
      ctx.shadowBlur = player.eliminated ? 0 : 8;
      ctx.strokeStyle = player.color;
      ctx.lineWidth = 2;

      switch (player.avatar) {
        case 'circle':
          ctx.beginPath();
          ctx.arc(x, y, s / 2, 0, Math.PI * 2);
          ctx.fill();
          break;
        case 'diamond':
          ctx.beginPath();
          ctx.moveTo(x, y - s / 2);
          ctx.lineTo(x + s / 2, y);
          ctx.lineTo(x, y + s / 2);
          ctx.lineTo(x - s / 2, y);
          ctx.closePath();
          ctx.fill();
          break;
        case 'square':
          ctx.fillRect(x - s / 2, y - s / 2, s, s);
          break;
        case 'triangle':
          ctx.beginPath();
          ctx.moveTo(x, y - s / 2);
          ctx.lineTo(x + s / 2, y + s / 2);
          ctx.lineTo(x - s / 2, y + s / 2);
          ctx.closePath();
          ctx.fill();
          break;
        case 'star':
          drawStar(x, y, 5, s / 2, s / 4);
          break;
        case 'cross':
          const t = s / 4;
          ctx.fillRect(x - t, y - s / 2, t * 2, s);
          ctx.fillRect(x - s / 2, y - t, s, t * 2);
          break;
        case 'hex':
          ctx.beginPath();
          for (let i = 0; i < 6; i++) {
            const a = Math.PI / 3 * i - Math.PI / 6;
            const px = x + Math.cos(a) * s / 2;
            const py = y + Math.sin(a) * s / 2;
            i === 0 ? ctx.moveTo(px, py) : ctx.lineTo(px, py);
          }
          ctx.closePath();
          ctx.fill();
          break;
        case 'shield':
          ctx.beginPath();
          ctx.moveTo(x - s / 2, y - s / 3);
          ctx.lineTo(x + s / 2, y - s / 3);
          ctx.lineTo(x + s / 2, y + s / 6);
          ctx.lineTo(x, y + s / 2);
          ctx.lineTo(x - s / 2, y + s / 6);
          ctx.closePath();
          ctx.fill();
          break;
      }
      ctx.shadowBlur = 0;
      ctx.restore();
    }

    function drawStar(cx, cy, spikes, outerR, innerR) {
      ctx.beginPath();
      for (let i = 0; i < spikes * 2; i++) {
        const r = i % 2 === 0 ? outerR : innerR;
        const a = (Math.PI * i) / spikes - Math.PI / 2;
        const x = cx + Math.cos(a) * r;
        const y = cy + Math.sin(a) * r;
        i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fill();
    }

    function drawPlayerSlots() {
      for (let i = 0; i < players.length; i++) {
        const p = players[i];
        const x = getPlayerSlotX(i);
        const y = getPlayerSlotY(i);
        const isTop = i < 4;

        // Avatar
        drawAvatar(x + 14, y + (isTop ? 10 : 18), p, 20);

        // Name
        ctx.font = '10px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = p.eliminated ? '#555' : p.color;
        ctx.shadowColor = p.eliminated ? 'transparent' : p.color;
        ctx.shadowBlur = p.eliminated ? 0 : 4;
        ctx.fillText(p.name, x + 28, y + (isTop ? 10 : 18));
        ctx.shadowBlur = 0;

        // Lives (hearts)
        const heartsY = isTop ? y + 22 : y + 30;
        for (let h = 0; h < 3; h++) {
          ctx.font = '10px Courier New';
          ctx.fillStyle = h < p.lives ? '#f44' : '#333';
          ctx.fillText('\u2665', x + 28 + h * 12, heartsY);
        }

        // Score
        ctx.fillStyle = p.eliminated ? '#444' : '#888';
        ctx.font = '9px Courier New';
        ctx.fillText(p.score + 'pts', x + 28 + 40, heartsY);

        // Elimination X
        if (p.eliminated) {
          ctx.strokeStyle = '#f00';
          ctx.lineWidth = 3;
          ctx.globalAlpha = 0.6;
          ctx.beginPath();
          ctx.moveTo(x + 4, y + (isTop ? 2 : 10));
          ctx.lineTo(x + 24, y + (isTop ? 22 : 30));
          ctx.moveTo(x + 24, y + (isTop ? 2 : 10));
          ctx.lineTo(x + 4, y + (isTop ? 22 : 30));
          ctx.stroke();
          ctx.globalAlpha = 1;
        }

        // Show answer indicator during reveal
        if (phase === 'reveal' && !p.eliminated) {
          let ans;
          if (p.isHuman) {
            ans = playerAnswer;
          } else {
            ans = aiAnswers[i - 1] ? aiAnswers[i - 1].choice : -1;
          }
          const correct = ans === currentQuestion.c;
          const indicator = correct ? '\u2713' : '\u2717';
          ctx.font = 'bold 14px Courier New';
          ctx.fillStyle = correct ? '#0f0' : '#f00';
          ctx.shadowColor = ctx.fillStyle;
          ctx.shadowBlur = 6;
          ctx.fillText(indicator, x + 2, y + (isTop ? 14 : 22));
          ctx.shadowBlur = 0;
        }
      }
    }

    function drawTimer() {
      const elapsed = (Date.now() - timerStart) / 1000;
      timer = Math.max(0, timerMax - elapsed);

      if (phase === 'question' && timer <= 0) {
        // Time's up! If player didn't answer, treat as wrong
        if (playerAnswer === -1 && !players[0].eliminated) {
          playerAnswer = -1; // explicitly no answer
        }
        revealAnswers();
        return;
      }

      // Timer bar
      const barY = 53;
      const barH = 8;
      const barW = 500;
      const barX = 50;
      const pct = timer / timerMax;

      // Background
      ctx.fillStyle = '#222';
      ctx.fillRect(barX, barY, barW, barH);

      // Fill
      let timerColor;
      if (pct > 0.5) timerColor = '#0f0';
      else if (pct > 0.25) timerColor = '#ff0';
      else timerColor = '#f00';

      ctx.fillStyle = timerColor;
      ctx.shadowColor = timerColor;
      ctx.shadowBlur = pct < 0.25 ? 12 : 4;
      ctx.fillRect(barX, barY, barW * pct, barH);
      ctx.shadowBlur = 0;

      // Timer text
      ctx.font = 'bold 12px Courier New';
      ctx.textAlign = 'right';
      ctx.fillStyle = timerColor;
      ctx.fillText(Math.ceil(timer) + 's', barX + barW + 40, barY + 8);
      ctx.textAlign = 'left';
    }

    function drawQuestion() {
      if (!currentQuestion) return;

      // Category badge
      const catColor = catColors[currentQuestion.cat] || '#f0a';
      ctx.font = 'bold 11px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = catColor;
      ctx.shadowColor = catColor;
      ctx.shadowBlur = 6;
      ctx.fillText('[ ' + currentQuestion.cat.toUpperCase() + ' ]  Round ' + currentRound + '/' + totalRounds, W / 2, 80);
      ctx.shadowBlur = 0;

      // Question text - word wrap
      ctx.font = 'bold 16px Courier New';
      ctx.fillStyle = '#fff';
      ctx.textAlign = 'center';
      const lines = wrapText(currentQuestion.q, W - 120);
      for (let i = 0; i < lines.length; i++) {
        ctx.fillText(lines[i], W / 2, 110 + i * 22);
      }

      // Alive count
      ctx.font = '11px Courier New';
      ctx.fillStyle = '#888';
      ctx.textAlign = 'center';
      const alive = countAlive();
      ctx.fillText(alive + ' player' + (alive !== 1 ? 's' : '') + ' remaining', W / 2, 110 + lines.length * 22 + 18);
    }

    function wrapText(text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let current = '';
      for (const word of words) {
        const test = current ? current + ' ' + word : word;
        if (ctx.measureText(test).width > maxWidth) {
          if (current) lines.push(current);
          current = word;
        } else {
          current = test;
        }
      }
      if (current) lines.push(current);
      return lines;
    }

    function drawChoices() {
      if (!currentQuestion) return;
      const correctIdx = currentQuestion.c;

      for (let i = 0; i < 4; i++) {
        const box = choiceBoxes[i];
        const label = String.fromCharCode(65 + i); // A, B, C, D

        let bgColor = '#1e1e3a';
        let borderColor = '#444';
        let textColor = '#ddd';
        let glow = 0;

        if (phase === 'reveal') {
          if (i === correctIdx) {
            bgColor = '#0a3a0a';
            borderColor = '#0f0';
            textColor = '#0f0';
            glow = 10;
          } else if (i === playerAnswer && i !== correctIdx) {
            bgColor = '#3a0a0a';
            borderColor = '#f00';
            textColor = '#f44';
            glow = 10;
          } else {
            bgColor = '#151525';
            borderColor = '#333';
            textColor = '#555';
          }
        } else if (phase === 'question') {
          if (i === playerAnswer) {
            bgColor = '#2a1a3a';
            borderColor = '#f0a';
            textColor = '#f0a';
            glow = 8;
          } else if (i === hoverChoice) {
            bgColor = '#252540';
            borderColor = '#f0a';
            textColor = '#fff';
            glow = 4;
          }
        }

        // Box background
        ctx.fillStyle = bgColor;
        ctx.shadowColor = borderColor;
        ctx.shadowBlur = glow;
        ctx.fillRect(box.x, box.y, box.w, box.h);

        // Border
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = 2;
        ctx.strokeRect(box.x, box.y, box.w, box.h);
        ctx.shadowBlur = 0;

        // Label
        ctx.font = 'bold 14px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = borderColor;
        ctx.fillText(label + '.', box.x + 12, box.y + box.h / 2 + 5);

        // Answer text
        ctx.font = '14px Courier New';
        ctx.fillStyle = textColor;
        ctx.fillText(currentQuestion.a[i], box.x + 40, box.y + box.h / 2 + 5);
      }
    }

    function drawEliminationBanner() {
      if (eliminatedThisRound.length === 0) return;
      if (phase !== 'reveal') return;

      const elapsed = (Date.now() - revealTime) / 1000;
      if (elapsed < 0.8 || elapsed > 2.3) return;

      const alpha = elapsed < 1.2 ? (elapsed - 0.8) / 0.4 : Math.max(0, 1 - (elapsed - 1.8) / 0.5);
      ctx.globalAlpha = alpha;

      ctx.fillStyle = 'rgba(60, 0, 0, 0.85)';
      ctx.fillRect(0, 200, W, 50);

      ctx.font = 'bold 18px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#f44';
      ctx.shadowColor = '#f00';
      ctx.shadowBlur = 15;

      const names = eliminatedThisRound.map(p => p.name).join(', ');
      ctx.fillText('ELIMINATED: ' + names, W / 2, 230);

      ctx.shadowBlur = 0;
      ctx.globalAlpha = 1;
    }

    function drawScreenEffects() {
      // Shake
      if (shakeAmount > 0) {
        shakeAmount *= 0.9;
        if (shakeAmount < 0.5) shakeAmount = 0;
      }

      // Flash
      if (flashAlpha > 0) {
        ctx.fillStyle = flashColor;
        ctx.globalAlpha = flashAlpha;
        ctx.fillRect(0, 0, W, H);
        ctx.globalAlpha = 1;
        flashAlpha *= 0.92;
        if (flashAlpha < 0.01) flashAlpha = 0;
      }
    }

    function draw() {
      ctx.save();
      if (shakeAmount > 0) {
        ctx.translate(
          (Math.random() - 0.5) * shakeAmount,
          (Math.random() - 0.5) * shakeAmount
        );
      }

      // Background
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, W, H);

      // Draw vignette
      const grad = ctx.createRadialGradient(W / 2, H / 2, 100, W / 2, H / 2, 400);
      grad.addColorStop(0, 'transparent');
      grad.addColorStop(1, 'rgba(0, 0, 0, 0.4)');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);

      if (phase === 'question' || phase === 'reveal') {
        // Separator lines for player slots
        ctx.strokeStyle = '#2a2a4e';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, 42);
        ctx.lineTo(W, 42);
        ctx.moveTo(0, H - 42);
        ctx.lineTo(W, H - 42);
        ctx.stroke();

        drawPlayerSlots();
        drawTimer();
        drawQuestion();
        drawChoices();
        drawEliminationBanner();
        drawParticles();
        drawScreenEffects();
      } else if (phase === 'gameOver') {
        drawPlayerSlots();
        drawFinalStandings();
        drawParticles();
      }

      ctx.restore();
    }

    function drawFinalStandings() {
      ctx.font = 'bold 20px Courier New';
      ctx.textAlign = 'center';
      ctx.fillStyle = '#f0a';
      ctx.shadowColor = '#f0a';
      ctx.shadowBlur = 12;
      ctx.fillText('FINAL STANDINGS', W / 2, 70);
      ctx.shadowBlur = 0;

      const sorted = [...players].sort((a, b) => {
        if (a.eliminated && !b.eliminated) return 1;
        if (!a.eliminated && b.eliminated) return -1;
        if (a.eliminated && b.eliminated) return b.eliminatedRound - a.eliminatedRound;
        return b.score - a.score;
      });

      for (let i = 0; i < sorted.length; i++) {
        const p = sorted[i];
        const y = 100 + i * 34;
        const rank = i + 1;

        // Rank medal colors
        let rankColor = '#888';
        if (rank === 1) rankColor = '#fd0';
        else if (rank === 2) rankColor = '#ccc';
        else if (rank === 3) rankColor = '#c84';

        ctx.font = 'bold 14px Courier New';
        ctx.textAlign = 'left';
        ctx.fillStyle = rankColor;
        ctx.fillText('#' + rank, 100, y);

        // Avatar
        drawAvatar(140, y - 5, p, 14);

        // Name
        ctx.font = '14px Courier New';
        ctx.fillStyle = p.eliminated ? '#555' : p.color;
        ctx.fillText(p.name, 160, y);

        // Score
        ctx.textAlign = 'right';
        ctx.fillStyle = p.eliminated ? '#555' : '#fff';
        ctx.fillText(p.score + ' pts', 420, y);

        // Status
        ctx.fillStyle = p.eliminated ? '#f44' : '#0f0';
        ctx.font = '11px Courier New';
        ctx.fillText(p.eliminated ? 'Eliminated R' + p.eliminatedRound : 'SURVIVED', 500, y);
        ctx.textAlign = 'left';
      }
    }

    // ===== INPUT =====
    canvas.addEventListener('mousemove', (e) => {
      if (phase !== 'question') { hoverChoice = -1; return; }
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (W / rect.width);
      const my = (e.clientY - rect.top) * (H / rect.height);

      hoverChoice = -1;
      for (let i = 0; i < 4; i++) {
        const box = choiceBoxes[i];
        if (mx >= box.x && mx <= box.x + box.w && my >= box.y && my <= box.y + box.h) {
          hoverChoice = i;
          break;
        }
      }
    });

    canvas.addEventListener('click', (e) => {
      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (W / rect.width);
      const my = (e.clientY - rect.top) * (H / rect.height);

      if (phase === 'question') {
        for (let i = 0; i < 4; i++) {
          const box = choiceBoxes[i];
          if (mx >= box.x && mx <= box.x + box.w && my >= box.y && my <= box.y + box.h) {
            submitAnswer(i);
            break;
          }
        }
      }
    });

    // Overlay click
    overlay.parentElement.addEventListener('click', () => {
      if (gameState === 'waiting') {
        gameState = 'playing';
        overlay.style.display = 'none';
        initGame();
      } else if (gameState === 'over') {
        gameState = 'playing';
        overlay.style.display = 'none';
        initGame();
      }
    });

    // ===== GAME LOOP =====
    function gameLoop() {
      if (gameState === 'playing') {
        updateParticles();
        draw();
      }
      requestAnimationFrame(gameLoop);
    }

    gameLoop();
  </script>
  <script src="../recorder.js?v=2"></script>
</body>
</html>
