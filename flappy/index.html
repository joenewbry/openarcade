<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flappy Bird</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      width: 400px;
    }
    .back { color: #ff0; text-decoration: none; font-size: 1.2rem; }
    .back:hover { text-shadow: 0 0 10px rgba(255, 255, 0, 0.5); }
    h1 { color: #ff0; font-size: 2rem; text-shadow: 0 0 15px rgba(255, 255, 0, 0.4); }
    .score-bar {
      display: flex;
      justify-content: space-between;
      width: 400px;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .score-bar span { color: #ff0; }
    canvas {
      border: 2px solid #ff0;
      box-shadow: 0 0 20px rgba(255, 255, 0, 0.2);
      display: block;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ff0;
      text-align: center;
      pointer-events: none;
      background: rgba(26, 26, 46, 0.85);
    }
    .overlay h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .overlay p { font-size: 1rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" class="back">&larr; Back</a>
    <h1>FLAPPY BIRD</h1>
  </div>
  <div class="score-bar">
    <div>Score: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div style="position: relative; display: inline-block;">
    <canvas id="game" width="400" height="600"></canvas>
    <div class="overlay" id="overlay" style="width:400px;height:600px;">
      <h2 id="overlayTitle">FLAPPY BIRD</h2>
      <p id="overlayText">Press Space or Up to start</p>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');

    const GRAVITY = 0.45;
    const FLAP_FORCE = -7.5;
    const PIPE_WIDTH = 60;
    const GAP_START = 240;
    const GAP_MIN = 130;
    const PIPE_SPEED = 3;
    const PIPE_SPACING = 200;
    const BIRD_SIZE = 18;

    let bird, pipes, score, best = 0, gameState, animFrame, frameCount;

    function init() {
      bird = { x: 80, y: H / 2, vy: 0, rotation: 0 };
      pipes = [];
      score = 0;
      frameCount = 0;
      scoreEl.textContent = '0';
      gameState = 'waiting';
      overlay.style.display = 'flex';
      overlayTitle.textContent = 'FLAPPY BIRD';
      overlayText.textContent = 'Press Space or Up to start';
      draw();
    }

    function start() {
      gameState = 'playing';
      overlay.style.display = 'none';
      flap();
      cancelAnimationFrame(animFrame);
      loop();
    }

    function flap() {
      bird.vy = FLAP_FORCE;
    }

    function loop() {
      if (gameState !== 'playing') return;
      update();
      draw();
      animFrame = requestAnimationFrame(loop);
    }

    function update() {
      frameCount++;

      // Bird physics
      bird.vy += GRAVITY;
      bird.y += bird.vy;
      bird.rotation = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, bird.vy * 0.08));

      // Ground/ceiling
      if (bird.y - BIRD_SIZE < 0) {
        bird.y = BIRD_SIZE;
        bird.vy = 0;
      }
      if (bird.y + BIRD_SIZE > H) {
        gameOver();
        return;
      }

      // Spawn pipes — gap shrinks as score increases
      if (pipes.length === 0 || pipes[pipes.length - 1].x < W - PIPE_SPACING) {
        const gap = Math.max(GAP_MIN, GAP_START - score * 5);
        const minTop = 80;
        const maxTop = H - gap - 80;
        const topH = minTop + Math.random() * (maxTop - minTop);
        pipes.push({ x: W, topH, gap, scored: false });
      }

      // Move pipes
      for (let i = pipes.length - 1; i >= 0; i--) {
        pipes[i].x -= PIPE_SPEED;

        // Remove off-screen
        if (pipes[i].x + PIPE_WIDTH < 0) {
          pipes.splice(i, 1);
          continue;
        }

        // Score
        if (!pipes[i].scored && pipes[i].x + PIPE_WIDTH < bird.x - BIRD_SIZE) {
          pipes[i].scored = true;
          score++;
          scoreEl.textContent = score;
          if (score > best) {
            best = score;
            bestEl.textContent = best;
          }
        }

        // Collision
        const p = pipes[i];
        const bx = bird.x, by = bird.y, br = BIRD_SIZE;
        if (bx + br > p.x && bx - br < p.x + PIPE_WIDTH) {
          if (by - br < p.topH || by + br > p.topH + p.gap) {
            gameOver();
            return;
          }
        }
      }
    }

    function gameOver() {
      gameState = 'over';
      cancelAnimationFrame(animFrame);
      overlay.style.display = 'flex';
      overlayTitle.textContent = 'GAME OVER';
      overlayText.textContent = `Score: ${score} — Press any key to restart`;
    }

    function draw() {
      // Background gradient
      const grad = ctx.createLinearGradient(0, 0, 0, H);
      grad.addColorStop(0, '#0a0a1a');
      grad.addColorStop(1, '#1a1a2e');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);

      // Stars
      ctx.fillStyle = '#ffffff08';
      for (let i = 0; i < 40; i++) {
        const sx = ((i * 137 + 83) % W);
        const sy = ((i * 251 + 47) % (H - 100));
        ctx.fillRect(sx, sy, 2, 2);
      }

      // Pipes
      pipes.forEach(p => {
        // Top pipe
        const topGrad = ctx.createLinearGradient(p.x, 0, p.x + PIPE_WIDTH, 0);
        topGrad.addColorStop(0, '#2a7a2a');
        topGrad.addColorStop(0.5, '#3a9a3a');
        topGrad.addColorStop(1, '#2a7a2a');
        ctx.fillStyle = topGrad;
        ctx.fillRect(p.x, 0, PIPE_WIDTH, p.topH);
        // Top pipe cap
        ctx.fillStyle = '#4aba4a';
        ctx.fillRect(p.x - 4, p.topH - 20, PIPE_WIDTH + 8, 20);
        ctx.strokeStyle = '#1a5a1a';
        ctx.lineWidth = 2;
        ctx.strokeRect(p.x - 4, p.topH - 20, PIPE_WIDTH + 8, 20);

        // Bottom pipe
        const botY = p.topH + p.gap;
        ctx.fillStyle = topGrad;
        ctx.fillRect(p.x, botY, PIPE_WIDTH, H - botY);
        // Bottom pipe cap
        ctx.fillStyle = '#4aba4a';
        ctx.fillRect(p.x - 4, botY, PIPE_WIDTH + 8, 20);
        ctx.strokeStyle = '#1a5a1a';
        ctx.strokeRect(p.x - 4, botY, PIPE_WIDTH + 8, 20);
      });

      // Bird
      ctx.save();
      ctx.translate(bird.x, bird.y);
      ctx.rotate(bird.rotation);

      // Body
      ctx.fillStyle = '#ff0';
      ctx.shadowColor = '#ff0';
      ctx.shadowBlur = 12;
      ctx.beginPath();
      ctx.ellipse(0, 0, BIRD_SIZE, BIRD_SIZE * 0.8, 0, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;

      // Wing
      ctx.fillStyle = '#ffa500';
      ctx.beginPath();
      const wingY = Math.sin(frameCount * 0.3) * 4;
      ctx.ellipse(-4, wingY, 10, 5, -0.3, 0, Math.PI * 2);
      ctx.fill();

      // Eye
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(8, -4, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(9, -4, 2.5, 0, Math.PI * 2);
      ctx.fill();

      // Beak
      ctx.fillStyle = '#f80';
      ctx.beginPath();
      ctx.moveTo(BIRD_SIZE - 2, -3);
      ctx.lineTo(BIRD_SIZE + 10, 0);
      ctx.lineTo(BIRD_SIZE - 2, 4);
      ctx.closePath();
      ctx.fill();

      ctx.restore();

      // Ground line
      ctx.fillStyle = '#2a5a2a';
      ctx.fillRect(0, H - 4, W, 4);
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === ' ' || e.key === 'ArrowUp') e.preventDefault();

      if (gameState === 'waiting') { start(); return; }
      if (gameState === 'over') { init(); return; }

      if (gameState === 'playing' && (e.key === ' ' || e.key === 'ArrowUp')) {
        flap();
      }
    });

    init();
  </script>
  <script src="../recorder.js?v=2"></script>
</body>
</html>
