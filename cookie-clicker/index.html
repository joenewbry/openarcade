<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cookie Clicker</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      width: 560px;
    }
    .back { color: #ed4; text-decoration: none; font-size: 1.2rem; }
    .back:hover { text-shadow: 0 0 10px rgba(238, 221, 68, 0.5); }
    h1 { color: #ed4; font-size: 2rem; text-shadow: 0 0 15px rgba(238, 221, 68, 0.4); }
    .score-bar {
      display: flex;
      justify-content: space-between;
      width: 560px;
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    .score-bar span { color: #ed4; }
    canvas {
      border: 2px solid #ed4;
      box-shadow: 0 0 20px rgba(238, 221, 68, 0.2);
      display: block;
      cursor: pointer;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ed4;
      text-align: center;
      pointer-events: none;
      background: rgba(26, 26, 46, 0.85);
    }
    .overlay h2 { font-size: 1.8rem; margin-bottom: 10px; }
    .overlay p { font-size: 1rem; color: #aaa; }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" class="back">&larr; Back</a>
    <h1>COOKIE CLICKER</h1>
  </div>
  <div class="score-bar">
    <div>Cookies: <span id="score">0</span></div>
    <div>Best: <span id="best">0</span></div>
  </div>
  <div style="position: relative; display: inline-block;">
    <canvas id="game" width="560" height="500"></canvas>
    <div class="overlay" id="overlay" style="width:560px;height:500px;">
      <h2 id="overlayTitle">COOKIE CLICKER</h2>
      <p id="overlayText">Click or press SPACE to start</p>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');

    // --- Global state for recorder ---
    let gameState = 'waiting';
    let score = 0;
    let best = 0;

    // --- Game constants ---
    const COOKIE_X = 160;
    const COOKIE_Y = 250;
    const COOKIE_RADIUS = 100;
    const SHOP_X = 330;
    const SHOP_W = 220;
    const MILESTONE = 1000000; // 1 million cookies triggers "win"

    // --- Buildings ---
    const BUILDING_DEFS = [
      { name: 'Cursor',  baseCost: 15,   cps: 0.1,  key: '1', color: '#ed4',  icon: '\u25C6' },
      { name: 'Grandma', baseCost: 100,  cps: 1,    key: '2', color: '#f80',  icon: '\u2665' },
      { name: 'Farm',    baseCost: 500,  cps: 5,    key: '3', color: '#0f0',  icon: '\u2618' },
      { name: 'Factory', baseCost: 3000, cps: 20,   key: '4', color: '#0ff',  icon: '\u2699' },
      { name: 'Mine',    baseCost: 10000, cps: 50,  key: '5', color: '#88f',  icon: '\u25B2' },
      { name: 'Bank',    baseCost: 40000, cps: 100,  key: '6', color: '#f0f',  icon: '\u0024' },
    ];

    // --- Game state ---
    let cookies = 0;
    let totalCookies = 0; // total cookies ever earned (= score)
    let cookiesPerClick = 1;
    let cps = 0; // cookies per second
    let buildings = [];
    let clickParticles = [];
    let cookieScale = 1;
    let cookieBounce = 0;
    let lastTime = 0;
    let floatingTexts = [];
    let cookieRotation = 0;
    let hoverBuilding = -1;
    let mouseX = 0, mouseY = 0;

    // Shop button rects for click detection
    let shopButtons = [];

    function getBuildingCost(index) {
      const def = BUILDING_DEFS[index];
      return Math.floor(def.baseCost * Math.pow(1.15, buildings[index].count));
    }

    function formatNumber(n) {
      if (n >= 1e12) return (n / 1e12).toFixed(1) + 'T';
      if (n >= 1e9) return (n / 1e9).toFixed(1) + 'B';
      if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
      if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
      return Math.floor(n).toString();
    }

    function init() {
      cookies = 0;
      totalCookies = 0;
      score = 0;
      cookiesPerClick = 1;
      cps = 0;
      clickParticles = [];
      floatingTexts = [];
      cookieScale = 1;
      cookieBounce = 0;
      cookieRotation = 0;
      hoverBuilding = -1;
      lastTime = 0;

      buildings = BUILDING_DEFS.map(() => ({ count: 0 }));

      scoreEl.textContent = '0';
      gameState = 'waiting';
      overlay.style.display = 'flex';
      overlayTitle.textContent = 'COOKIE CLICKER';
      overlayText.textContent = 'Click or press SPACE to start';
      draw();
    }

    function start() {
      gameState = 'playing';
      overlay.style.display = 'none';
      lastTime = performance.now();
      loop(lastTime);
    }

    function gameOver() {
      gameState = 'over';
      if (score > best) {
        best = score;
        bestEl.textContent = formatNumber(best);
      }
      overlay.style.display = 'flex';
      overlayTitle.textContent = 'GAME OVER';
      overlayText.textContent = `${formatNumber(totalCookies)} cookies! Press any key to restart`;
    }

    function recalcCPS() {
      cps = 0;
      for (let i = 0; i < BUILDING_DEFS.length; i++) {
        cps += BUILDING_DEFS[i].cps * buildings[i].count;
      }
    }

    function buyBuilding(index) {
      const cost = getBuildingCost(index);
      if (cookies >= cost) {
        cookies -= cost;
        buildings[index].count++;
        recalcCPS();
        // Each cursor adds +0.1 to click power
        if (index === 0) {
          cookiesPerClick = 1 + buildings[0].count * 0.1;
        }
        return true;
      }
      return false;
    }

    function clickCookie(x, y) {
      const earned = cookiesPerClick;
      cookies += earned;
      totalCookies += earned;
      score = Math.floor(totalCookies);
      scoreEl.textContent = formatNumber(score);
      if (score > best) {
        best = score;
        bestEl.textContent = formatNumber(best);
      }

      // Visual feedback
      cookieBounce = 1;

      // Floating text
      floatingTexts.push({
        x: COOKIE_X + (Math.random() - 0.5) * 60,
        y: COOKIE_Y - COOKIE_RADIUS - 10,
        text: '+' + formatNumber(earned),
        alpha: 1,
        vy: -1.5
      });

      // Particles
      for (let i = 0; i < 5; i++) {
        const angle = Math.random() * Math.PI * 2;
        const speed = 1 + Math.random() * 3;
        clickParticles.push({
          x: COOKIE_X + Math.cos(angle) * 20,
          y: COOKIE_Y + Math.sin(angle) * 20,
          vx: Math.cos(angle) * speed,
          vy: Math.sin(angle) * speed,
          life: 1,
          color: '#ed4'
        });
      }

      // Check milestone
      if (totalCookies >= MILESTONE) {
        gameOver();
      }
    }

    function isInsideCookie(x, y) {
      const dx = x - COOKIE_X;
      const dy = y - COOKIE_Y;
      return dx * dx + dy * dy <= COOKIE_RADIUS * COOKIE_RADIUS;
    }

    function update(dt) {
      // Passive cookie generation
      if (cps > 0) {
        const earned = cps * dt;
        cookies += earned;
        totalCookies += earned;
        score = Math.floor(totalCookies);
        scoreEl.textContent = formatNumber(score);
        if (score > best) {
          best = score;
          bestEl.textContent = formatNumber(best);
        }
      }

      // Cookie bounce animation
      if (cookieBounce > 0) {
        cookieBounce -= dt * 5;
        if (cookieBounce < 0) cookieBounce = 0;
      }
      cookieScale = 1 + cookieBounce * 0.1;

      // Slow rotation
      cookieRotation += dt * 0.3;

      // Update floating texts
      for (let i = floatingTexts.length - 1; i >= 0; i--) {
        const ft = floatingTexts[i];
        ft.y += ft.vy;
        ft.alpha -= dt * 1.5;
        if (ft.alpha <= 0) floatingTexts.splice(i, 1);
      }

      // Update particles
      for (let i = clickParticles.length - 1; i >= 0; i--) {
        const p = clickParticles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= dt * 2;
        if (p.life <= 0) clickParticles.splice(i, 1);
      }

      // Check milestone
      if (totalCookies >= MILESTONE) {
        gameOver();
      }

      // Expose game data for ML
      window.gameData = {
        cookies: Math.floor(cookies),
        totalCookies: Math.floor(totalCookies),
        cps: cps,
        cookiesPerClick: cookiesPerClick,
        buildings: buildings.map((b, i) => ({
          name: BUILDING_DEFS[i].name,
          count: b.count,
          cost: getBuildingCost(i)
        }))
      };
    }

    function drawCookie() {
      ctx.save();
      ctx.translate(COOKIE_X, COOKIE_Y);
      ctx.scale(cookieScale, cookieScale);
      ctx.rotate(cookieRotation * 0.05);

      // Cookie body (circle)
      const grad = ctx.createRadialGradient(0, 0, 10, 0, 0, COOKIE_RADIUS);
      grad.addColorStop(0, '#d4a030');
      grad.addColorStop(0.6, '#b8860b');
      grad.addColorStop(1, '#8B6914');

      ctx.shadowColor = '#ed4';
      ctx.shadowBlur = 20 + cookieBounce * 15;
      ctx.beginPath();
      ctx.arc(0, 0, COOKIE_RADIUS, 0, Math.PI * 2);
      ctx.fillStyle = grad;
      ctx.fill();
      ctx.shadowBlur = 0;

      // Cookie edge (scalloped)
      ctx.strokeStyle = '#8B6914';
      ctx.lineWidth = 3;
      ctx.beginPath();
      for (let i = 0; i < 24; i++) {
        const angle = (i / 24) * Math.PI * 2;
        const r = COOKIE_RADIUS - 2 + Math.sin(i * 3.7) * 4;
        if (i === 0) ctx.moveTo(Math.cos(angle) * r, Math.sin(angle) * r);
        else ctx.lineTo(Math.cos(angle) * r, Math.sin(angle) * r);
      }
      ctx.closePath();
      ctx.stroke();

      // Chocolate chips
      const chips = [
        { x: -30, y: -40, r: 10 },
        { x: 25, y: -25, r: 9 },
        { x: -15, y: 10, r: 11 },
        { x: 35, y: 20, r: 8 },
        { x: -40, y: 30, r: 9 },
        { x: 10, y: 45, r: 10 },
        { x: -55, y: -10, r: 8 },
        { x: 50, y: -5, r: 7 },
        { x: 5, y: -55, r: 8 },
      ];

      chips.forEach(chip => {
        const cg = ctx.createRadialGradient(chip.x, chip.y, 1, chip.x, chip.y, chip.r);
        cg.addColorStop(0, '#5c3d2e');
        cg.addColorStop(1, '#3a2518');
        ctx.beginPath();
        ctx.arc(chip.x, chip.y, chip.r, 0, Math.PI * 2);
        ctx.fillStyle = cg;
        ctx.fill();
      });

      ctx.restore();
    }

    function drawShop() {
      shopButtons = [];

      // Shop panel background
      ctx.fillStyle = '#16213e';
      ctx.fillRect(SHOP_X, 0, SHOP_W, H);

      // Divider line
      ctx.fillStyle = '#0f3460';
      ctx.fillRect(SHOP_X, 0, 2, H);

      // Shop title
      ctx.fillStyle = '#ed4';
      ctx.shadowColor = '#ed4';
      ctx.shadowBlur = 8;
      ctx.font = 'bold 16px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText('SHOP', SHOP_X + SHOP_W / 2, 30);
      ctx.shadowBlur = 0;

      // CPS display
      ctx.fillStyle = '#aaa';
      ctx.font = '12px "Courier New", monospace';
      ctx.fillText(formatNumber(cps) + ' per second', SHOP_X + SHOP_W / 2, 50);

      // Cookie count in shop area
      ctx.fillStyle = '#ed4';
      ctx.font = 'bold 14px "Courier New", monospace';
      ctx.fillText(formatNumber(Math.floor(cookies)) + ' cookies', SHOP_X + SHOP_W / 2, 72);

      // Buildings
      const startY = 90;
      const btnH = 62;
      const btnPad = 6;
      const btnW = SHOP_W - 20;

      for (let i = 0; i < BUILDING_DEFS.length; i++) {
        const def = BUILDING_DEFS[i];
        const cost = getBuildingCost(i);
        const canAfford = cookies >= cost;
        const bx = SHOP_X + 10;
        const by = startY + i * (btnH + btnPad);

        shopButtons.push({ x: bx, y: by, w: btnW, h: btnH, index: i });

        // Button background
        const isHovered = hoverBuilding === i;
        ctx.fillStyle = isHovered ? '#1a2a4e' : '#0f1a30';
        ctx.fillRect(bx, by, btnW, btnH);

        // Button border
        ctx.strokeStyle = canAfford ? def.color : '#333';
        ctx.lineWidth = canAfford && isHovered ? 2 : 1;
        if (canAfford && isHovered) {
          ctx.shadowColor = def.color;
          ctx.shadowBlur = 8;
        }
        ctx.strokeRect(bx, by, btnW, btnH);
        ctx.shadowBlur = 0;

        // Icon
        ctx.fillStyle = canAfford ? def.color : '#555';
        ctx.font = '20px "Courier New", monospace';
        ctx.textAlign = 'left';
        ctx.fillText(def.icon, bx + 8, by + 28);

        // Name and key hint
        ctx.fillStyle = canAfford ? '#e0e0e0' : '#666';
        ctx.font = 'bold 13px "Courier New", monospace';
        ctx.fillText(def.name, bx + 32, by + 20);

        // Key shortcut
        ctx.fillStyle = canAfford ? '#888' : '#444';
        ctx.font = '10px "Courier New", monospace';
        ctx.textAlign = 'right';
        ctx.fillText('[' + def.key + ']', bx + btnW - 6, by + 20);

        // Cost
        ctx.textAlign = 'left';
        ctx.fillStyle = canAfford ? '#ed4' : '#663';
        ctx.font = '12px "Courier New", monospace';
        ctx.fillText(formatNumber(cost) + ' cookies', bx + 32, by + 38);

        // Count owned
        ctx.textAlign = 'right';
        ctx.fillStyle = canAfford ? def.color : '#444';
        ctx.font = 'bold 18px "Courier New", monospace';
        ctx.fillText(buildings[i].count.toString(), bx + btnW - 6, by + 50);

        // CPS contribution
        ctx.fillStyle = '#666';
        ctx.font = '10px "Courier New", monospace';
        ctx.textAlign = 'left';
        ctx.fillText('+' + def.cps + '/s each', bx + 32, by + 54);
      }

      ctx.textAlign = 'left';
    }

    function draw() {
      // Clear canvas
      ctx.fillStyle = '#1a1a2e';
      ctx.fillRect(0, 0, W, H);

      // Left area: cookie + info
      // Subtle grid pattern
      ctx.strokeStyle = '#16213e';
      ctx.lineWidth = 1;
      for (let x = 0; x < SHOP_X; x += 40) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, H);
        ctx.stroke();
      }
      for (let y = 0; y < H; y += 40) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(SHOP_X, y);
        ctx.stroke();
      }

      // Cookie count display (above cookie)
      ctx.fillStyle = '#ed4';
      ctx.shadowColor = '#ed4';
      ctx.shadowBlur = 10;
      ctx.font = 'bold 28px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText(formatNumber(Math.floor(cookies)), COOKIE_X, 50);
      ctx.shadowBlur = 0;

      ctx.fillStyle = '#aaa';
      ctx.font = '14px "Courier New", monospace';
      ctx.fillText('cookies', COOKIE_X, 72);

      // CPS display
      ctx.fillStyle = '#888';
      ctx.font = '12px "Courier New", monospace';
      ctx.fillText(formatNumber(cps) + ' per second', COOKIE_X, 92);

      // Click power display
      ctx.fillStyle = '#666';
      ctx.font = '11px "Courier New", monospace';
      ctx.fillText('+' + cookiesPerClick.toFixed(1) + ' per click', COOKIE_X, 110);

      // Draw the cookie
      drawCookie();

      // Hint text below cookie
      ctx.fillStyle = '#555';
      ctx.font = '11px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText('Click cookie or press SPACE', COOKIE_X, COOKIE_Y + COOKIE_RADIUS + 30);
      ctx.fillText('Keys 1-6 to buy buildings', COOKIE_X, COOKIE_Y + COOKIE_RADIUS + 48);

      // Progress to milestone
      const progress = Math.min(totalCookies / MILESTONE, 1);
      const barX = 30;
      const barY = H - 40;
      const barW = SHOP_X - 60;
      const barH = 12;

      ctx.fillStyle = '#0f1a30';
      ctx.fillRect(barX, barY, barW, barH);
      ctx.fillStyle = '#ed4';
      ctx.shadowColor = '#ed4';
      ctx.shadowBlur = progress > 0.5 ? 8 : 4;
      ctx.fillRect(barX, barY, barW * progress, barH);
      ctx.shadowBlur = 0;
      ctx.strokeStyle = '#0f3460';
      ctx.strokeRect(barX, barY, barW, barH);

      ctx.fillStyle = '#888';
      ctx.font = '10px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.fillText('Goal: 1M cookies (' + (progress * 100).toFixed(1) + '%)', COOKIE_X, barY - 6);

      // Floating texts
      floatingTexts.forEach(ft => {
        ctx.globalAlpha = ft.alpha;
        ctx.fillStyle = '#ed4';
        ctx.shadowColor = '#ed4';
        ctx.shadowBlur = 6;
        ctx.font = 'bold 18px "Courier New", monospace';
        ctx.textAlign = 'center';
        ctx.fillText(ft.text, ft.x, ft.y);
        ctx.shadowBlur = 0;
      });
      ctx.globalAlpha = 1;

      // Particles
      clickParticles.forEach(p => {
        ctx.globalAlpha = p.life;
        ctx.fillStyle = p.color;
        ctx.shadowColor = p.color;
        ctx.shadowBlur = 4;
        ctx.fillRect(p.x - 2, p.y - 2, 4, 4);
        ctx.shadowBlur = 0;
      });
      ctx.globalAlpha = 1;

      // Draw shop panel
      drawShop();

      ctx.textAlign = 'left';
    }

    function loop(timestamp) {
      if (gameState !== 'playing') return;
      const dt = Math.min((timestamp - lastTime) / 1000, 0.1); // cap delta
      lastTime = timestamp;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    // --- Input handlers ---

    function getCanvasPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left) * (W / rect.width),
        y: (e.clientY - rect.top) * (H / rect.height)
      };
    }

    canvas.addEventListener('mousemove', (e) => {
      const pos = getCanvasPos(e);
      mouseX = pos.x;
      mouseY = pos.y;

      // Check hover on shop buttons
      hoverBuilding = -1;
      for (const btn of shopButtons) {
        if (pos.x >= btn.x && pos.x <= btn.x + btn.w &&
            pos.y >= btn.y && pos.y <= btn.y + btn.h) {
          hoverBuilding = btn.index;
          break;
        }
      }
    });

    canvas.addEventListener('click', (e) => {
      if (gameState === 'waiting') { start(); return; }
      if (gameState === 'over') { init(); return; }
      if (gameState !== 'playing') return;

      const pos = getCanvasPos(e);

      // Check cookie click
      if (isInsideCookie(pos.x, pos.y)) {
        clickCookie(pos.x, pos.y);
        return;
      }

      // Check shop button clicks
      for (const btn of shopButtons) {
        if (pos.x >= btn.x && pos.x <= btn.x + btn.w &&
            pos.y >= btn.y && pos.y <= btn.y + btn.h) {
          buyBuilding(btn.index);
          return;
        }
      }
    });

    canvas.addEventListener('contextmenu', (e) => e.preventDefault());

    document.addEventListener('keydown', (e) => {
      if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
        e.preventDefault();
      }

      if (gameState === 'waiting') {
        start();
        return;
      }

      if (gameState === 'over') {
        init();
        return;
      }

      if (gameState === 'playing') {
        // Space = click cookie
        if (e.key === ' ') {
          clickCookie(COOKIE_X, COOKIE_Y);
          return;
        }

        // Number keys 1-6 = buy building
        const keyNum = parseInt(e.key);
        if (keyNum >= 1 && keyNum <= BUILDING_DEFS.length) {
          buyBuilding(keyNum - 1);
          return;
        }
      }
    });

    init();
  </script>
  <script src="../recorder.js?v=3"></script>
<script src="../rating.js?v=1"></script>
</body>
</html>
