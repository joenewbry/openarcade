<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real Estate Mogul</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #1a1a2e;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 16px;
      width: 600px;
    }
    .back { color: #f90; text-decoration: none; font-size: 1.2rem; }
    .back:hover { text-shadow: 0 0 10px rgba(255, 153, 0, 0.5); }
    h1 { color: #f90; font-size: 1.4rem; text-shadow: 0 0 15px rgba(255, 153, 0, 0.4); }
    .score-bar {
      display: flex;
      justify-content: space-between;
      width: 600px;
      margin-bottom: 10px;
      font-size: 1rem;
    }
    .score-bar span { color: #f90; }
    canvas {
      border: 2px solid #f90;
      box-shadow: 0 0 20px rgba(255, 153, 0, 0.2);
      display: block;
      cursor: pointer;
    }
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #f90;
      text-align: center;
      pointer-events: none;
      background: rgba(26, 26, 46, 0.88);
    }
    .overlay h2 { font-size: 1.8rem; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255, 153, 0, 0.6); }
    .overlay p { font-size: 1rem; color: #aaa; max-width: 420px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="header">
    <a href="../" class="back">&larr; Back</a>
    <h1>REAL ESTATE MOGUL</h1>
  </div>
  <div class="score-bar">
    <div>Net Worth: $<span id="score">500,000</span></div>
    <div>Best: $<span id="best">0</span></div>
  </div>
  <div style="position: relative; display: inline-block;">
    <canvas id="game" width="600" height="500"></canvas>
    <div class="overlay" id="overlay" style="width:600px;height:500px;">
      <h2 id="overlayTitle">REAL ESTATE MOGUL</h2>
      <p id="overlayText">Buy, develop, and sell properties to become the wealthiest tycoon.<br><br>Click to Start</p>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const W = 600, H = 500;
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const overlay = document.getElementById('overlay');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayText = document.getElementById('overlayText');

    let gameState = 'waiting';
    let score = 0;
    let bestScore = parseInt(localStorage.getItem('realEstateMogulBest') || '0');
    bestEl.textContent = bestScore.toLocaleString();

    const ORANGE = '#f90';
    const BG = '#1a1a2e';
    const PANEL_BG = '#12122a';
    const GRID_BG = '#0e0e22';

    const PROP_TYPES = {
      residential: { label: 'Residential', color: '#4a9', icon: '\u2302', baseValue: [40000, 80000], baseRent: [2000, 5000] },
      commercial:  { label: 'Commercial',  color: '#49f', icon: '\u2616', baseValue: [60000, 120000], baseRent: [4000, 8000] },
      industrial:  { label: 'Industrial',  color: '#a86', icon: '\u2692', baseValue: [30000, 60000], baseRent: [3000, 6000] },
      luxury:      { label: 'Luxury',      color: '#d4a', icon: '\u2605', baseValue: [100000, 200000], baseRent: [6000, 12000] }
    };

    const NEIGHBORHOODS = ['Downtown', 'Suburbia', 'Waterfront', 'Hillside', 'Midtown', 'Eastside'];

    const MARKET_EVENTS = [
      { text: 'Tech Boom!', desc: 'Commercial +20%', effect: (p) => p.type === 'commercial' ? 1.20 : 1.0 },
      { text: 'Housing Crash', desc: 'Residential -15%', effect: (p) => p.type === 'residential' ? 0.85 : 1.0 },
      { text: 'Gentrification', desc: '{hood} values +25%', effect: null, neighborhood: true, mult: 1.25 },
      { text: 'Industrial Boom', desc: 'Industrial +20%', effect: (p) => p.type === 'industrial' ? 1.20 : 1.0 },
      { text: 'Luxury Tax Hike', desc: 'Luxury -10%', effect: (p) => p.type === 'luxury' ? 0.90 : 1.0 },
      { text: 'Population Growth', desc: 'All rents +10%', effect: () => 1.0, rentMult: 1.10 },
      { text: 'Recession Fears', desc: 'All values -8%', effect: () => 0.92 },
      { text: 'New Highway', desc: 'Suburbia +15%', effect: null, neighborhoodName: 'Suburbia', mult: 1.15 },
      { text: 'Beach Festival', desc: 'Waterfront +18%', effect: null, neighborhoodName: 'Waterfront', mult: 1.18 },
      { text: 'Downtown Revival', desc: 'Downtown +15%', effect: null, neighborhoodName: 'Downtown', mult: 1.15 },
      { text: 'Stable Market', desc: 'No major changes', effect: () => 1.0 },
      { text: 'Build Boom', desc: 'Dev costs -20%', effect: () => 1.0, devDiscount: 0.8 },
      { text: 'Tax Cut', desc: 'All values +5%', effect: () => 1.05 },
      { text: 'Investor Exodus', desc: 'Comm -12%, Ind -10%', effect: (p) => p.type === 'commercial' ? 0.88 : (p.type === 'industrial' ? 0.90 : 1.0) },
      { text: 'Luxury Surge', desc: 'Luxury +22%', effect: (p) => p.type === 'luxury' ? 1.22 : 1.0 }
    ];

    const PLAYER_COLORS = ['#f90', '#4af', '#f55', '#5d5'];
    const PLAYER_NAMES = ['You', 'AI-Rex', 'AI-Nova', 'AI-Max'];

    let players = [];
    let properties = [];
    let currentPlayer = 0;
    let round = 1;
    let maxRounds = 20;
    let phase = 'start';
    let currentEvent = null;
    let selectedProperty = null;
    let hoveredProperty = null;
    let hoveredButton = null;
    let actionsTaken = 0;
    let maxActions = 2;
    let eventLog = [];
    let devDiscount = 1.0;
    let animTimer = 0;
    let numPlayers = 4;
    let rentCollected = 0;

    const MAP_X = 10, MAP_Y = 10, MAP_W = 340, MAP_H = 310;
    const PANEL_X = 360, PANEL_Y = 10, PANEL_W = 230, PANEL_H = 310;
    const STATS_X = 10, STATS_Y = 330, STATS_W = 580, STATS_H = 70;
    const ACTION_X = 10, ACTION_Y = 408, ACTION_W = 580, ACTION_H = 84;

    const GRID_COLS = 5, GRID_ROWS = 4;
    const CELL_PAD = 6;
    const CELL_W = (MAP_W - CELL_PAD * (GRID_COLS + 1)) / GRID_COLS;
    const CELL_H = (MAP_H - 30 - CELL_PAD * (GRID_ROWS + 1)) / GRID_ROWS;

    let buttons = [];

    function rand(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function fmt$(n) { return '$' + Math.round(n).toLocaleString(); }

    function initGame() {
      players = [];
      for (let i = 0; i < numPlayers; i++) {
        players.push({ name: PLAYER_NAMES[i], cash: 500000, color: PLAYER_COLORS[i], isAI: i > 0 });
      }

      properties = [];
      const types = Object.keys(PROP_TYPES);
      for (let row = 0; row < GRID_ROWS; row++) {
        for (let col = 0; col < GRID_COLS; col++) {
          const type = types[row];
          const info = PROP_TYPES[type];
          const hood = NEIGHBORHOODS[rand(0, NEIGHBORHOODS.length - 1)];
          const baseVal = rand(info.baseValue[0], info.baseValue[1]);
          const baseRent = rand(info.baseRent[0], info.baseRent[1]);
          properties.push({
            row, col, type, neighborhood: hood,
            value: baseVal, rent: baseRent,
            condition: rand(50, 100),
            devLevel: 0, maxDev: 3,
            owner: -1,
            x: MAP_X + CELL_PAD + col * (CELL_W + CELL_PAD),
            y: MAP_Y + 24 + CELL_PAD + row * (CELL_H + CELL_PAD)
          });
        }
      }

      round = 1;
      currentPlayer = 0;
      phase = 'event';
      selectedProperty = null;
      hoveredProperty = null;
      actionsTaken = 0;
      eventLog = [];
      devDiscount = 1.0;
      rentCollected = 0;
      applyMarketEvent();
    }

    function applyMarketEvent() {
      let evt = MARKET_EVENTS[rand(0, MARKET_EVENTS.length - 1)];
      let desc = evt.desc;
      let targetHood = null;

      if (evt.neighborhood) {
        targetHood = pick(NEIGHBORHOODS);
        desc = desc.replace('{hood}', targetHood);
      } else if (evt.neighborhoodName) {
        targetHood = evt.neighborhoodName;
      }

      devDiscount = evt.devDiscount || 1.0;

      for (let p of properties) {
        let mult = 1.0;
        if (targetHood) {
          if (p.neighborhood === targetHood) mult = evt.mult;
        } else if (evt.effect) {
          mult = evt.effect(p);
        }
        p.value = Math.max(5000, Math.round(p.value * mult));
        if (evt.rentMult) {
          p.rent = Math.round(p.rent * evt.rentMult);
        }
      }

      currentEvent = { text: evt.text, desc: desc };
      eventLog.unshift('R' + round + ': ' + evt.text);
      if (eventLog.length > 10) eventLog.pop();
    }

    function collectRent(playerIdx) {
      let total = 0;
      for (let p of properties) {
        if (p.owner === playerIdx) {
          let r = Math.round(p.rent * (p.condition / 100));
          total += r;
          players[playerIdx].cash += r;
        }
      }
      return total;
    }

    function getPlayerNetWorth(idx) {
      let worth = players[idx].cash;
      for (let p of properties) {
        if (p.owner === idx) worth += p.value;
      }
      return worth;
    }

    function getPlayerPropertyCount(idx) {
      let count = 0;
      for (let p of properties) { if (p.owner === idx) count++; }
      return count;
    }

    function getDevCost(prop) {
      return Math.round(prop.value * 0.3 * devDiscount);
    }

    function developProperty(prop) {
      if (prop.devLevel >= prop.maxDev) return false;
      let cost = getDevCost(prop);
      if (players[prop.owner].cash < cost) return false;
      players[prop.owner].cash -= cost;
      prop.devLevel++;
      prop.value = Math.round(prop.value * 1.35);
      prop.rent = Math.round(prop.rent * 1.25);
      prop.condition = Math.min(100, prop.condition + 15);
      return true;
    }

    function buyProperty(prop, playerIdx) {
      if (prop.owner !== -1) return false;
      if (players[playerIdx].cash < prop.value) return false;
      players[playerIdx].cash -= prop.value;
      prop.owner = playerIdx;
      return true;
    }

    function sellProperty(prop) {
      if (prop.owner === -1) return false;
      let price = Math.round(prop.value * 0.9);
      players[prop.owner].cash += price;
      prop.owner = -1;
      prop.devLevel = 0;
      return true;
    }

    function aiTurn(playerIdx) {
      let p = players[playerIdx];
      let actions = 0;

      while (actions < maxActions) {
        let owned = properties.filter(pr => pr.owner === playerIdx);
        let available = properties.filter(pr => pr.owner === -1);
        let acted = false;

        // Sell overvalued or degraded properties
        for (let prop of owned) {
          if (prop.condition < 30 && prop.devLevel >= prop.maxDev) {
            sellProperty(prop);
            acted = true; actions++; break;
          }
          let typeInfo = PROP_TYPES[prop.type];
          let avgBase = (typeInfo.baseValue[0] + typeInfo.baseValue[1]) / 2;
          if (prop.value > avgBase * 2.0 && Math.random() < 0.35) {
            sellProperty(prop);
            acted = true; actions++; break;
          }
        }
        if (acted) continue;

        // Develop good properties
        let devCands = owned.filter(pr => pr.devLevel < pr.maxDev && p.cash >= getDevCost(pr));
        if (devCands.length > 0 && Math.random() < 0.55) {
          devCands.sort((a, b) => (b.rent * 1.25 / getDevCost(b)) - (a.rent * 1.25 / getDevCost(a)));
          developProperty(devCands[0]);
          acted = true; actions++; continue;
        }

        // Buy high-ROI properties
        let affordable = available.filter(pr => p.cash >= pr.value);
        if (affordable.length > 0 && p.cash > 80000) {
          affordable.sort((a, b) => (b.rent / b.value) - (a.rent / a.value));
          let best = affordable[0];
          let roi = best.rent / best.value;
          if (roi > 0.035 || (p.cash > 250000 && roi > 0.02)) {
            buyProperty(best, playerIdx);
            acted = true; actions++; continue;
          }
        }

        break;
      }
    }

    function advanceTurn() {
      for (let i = 1; i < numPlayers; i++) {
        collectRent(i);
        aiTurn(i);
      }

      for (let p of properties) {
        if (p.owner !== -1) {
          p.condition = Math.max(10, p.condition - rand(2, 5));
        }
      }

      round++;
      if (round > maxRounds) {
        endGame();
        return;
      }

      currentPlayer = 0;
      actionsTaken = 0;
      selectedProperty = null;
      phase = 'event';
      applyMarketEvent();
    }

    function endGame() {
      phase = 'gameOver';
      gameState = 'over';
      let nw = getPlayerNetWorth(0);
      score = nw;
      scoreEl.textContent = nw.toLocaleString();

      let rankings = [];
      for (let i = 0; i < numPlayers; i++) {
        rankings.push({ idx: i, nw: getPlayerNetWorth(i) });
      }
      rankings.sort((a, b) => b.nw - a.nw);
      let rank = rankings.findIndex(r => r.idx === 0) + 1;

      if (nw > bestScore) {
        bestScore = nw;
        localStorage.setItem('realEstateMogulBest', bestScore.toString());
        bestEl.textContent = bestScore.toLocaleString();
      }

      let txt = 'Final Net Worth: ' + fmt$(nw) + '\n';
      txt += 'You placed #' + rank + ' of ' + numPlayers + '\n\n';
      for (let r of rankings) {
        let marker = r.idx === 0 ? '  \u25c0' : '';
        txt += PLAYER_NAMES[r.idx] + ': ' + fmt$(r.nw) + marker + '\n';
      }

      overlayTitle.textContent = rank === 1 ? 'MOGUL SUPREME!' : 'GAME OVER';
      overlayText.innerHTML = txt.replace(/\n/g, '<br>') + '<br><br>Click to play again';
      overlay.style.display = 'flex';
    }

    // ====== DRAWING ======

    function draw() {
      ctx.fillStyle = BG;
      ctx.fillRect(0, 0, W, H);
      animTimer += 0.02;

      drawMap();
      drawPanel();
      drawStats();
      drawActions();
    }

    function drawMap() {
      ctx.fillStyle = GRID_BG;
      ctx.strokeStyle = ORANGE + '60';
      ctx.lineWidth = 1;
      roundRect(MAP_X, MAP_Y, MAP_W, MAP_H, 6, true, true);

      ctx.fillStyle = ORANGE;
      ctx.font = 'bold 11px Courier New';
      ctx.textAlign = 'center';
      ctx.shadowColor = ORANGE;
      ctx.shadowBlur = 8;
      ctx.fillText('PROPERTY MAP  \u2022  Round ' + round + '/' + maxRounds, MAP_X + MAP_W / 2, MAP_Y + 16);
      ctx.shadowBlur = 0;

      // Row type labels
      const types = ['residential', 'commercial', 'industrial', 'luxury'];

      for (let p of properties) {
        let info = PROP_TYPES[p.type];
        let isHov = hoveredProperty === p;
        let isSel = selectedProperty === p;
        let x = p.x, y = p.y;

        // Cell background
        if (p.owner >= 0) {
          ctx.fillStyle = players[p.owner].color + '25';
        } else {
          ctx.fillStyle = '#1a1a36';
        }
        ctx.fillRect(x, y, CELL_W, CELL_H);

        // Ownership stripe at top
        if (p.owner >= 0) {
          ctx.fillStyle = players[p.owner].color + '90';
          ctx.fillRect(x, y, CELL_W, 3);
        }

        // Border
        if (isSel) {
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.shadowColor = '#fff';
          ctx.shadowBlur = 12;
        } else if (isHov) {
          ctx.strokeStyle = info.color;
          ctx.lineWidth = 2;
          ctx.shadowColor = info.color;
          ctx.shadowBlur = 8;
        } else {
          ctx.strokeStyle = info.color + '60';
          ctx.lineWidth = 1;
          ctx.shadowBlur = 0;
        }
        ctx.strokeRect(x, y, CELL_W, CELL_H);
        ctx.shadowBlur = 0;

        // Type letter
        ctx.fillStyle = info.color;
        ctx.font = 'bold 18px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText(info.label[0], x + CELL_W / 2, y + 22);

        // Value
        ctx.fillStyle = '#aaa';
        ctx.font = '8px Courier New';
        let shortVal = Math.round(p.value / 1000) + 'k';
        ctx.fillText('$' + shortVal, x + CELL_W / 2, y + 34);

        // Dev dots
        for (let d = 0; d < p.maxDev; d++) {
          let dx = x + CELL_W / 2 - 12 + d * 10;
          let dy = y + CELL_H - 12;
          ctx.beginPath();
          ctx.arc(dx + 3, dy + 3, 3, 0, Math.PI * 2);
          if (d < p.devLevel) {
            ctx.fillStyle = '#ff0';
            ctx.fill();
          } else {
            ctx.strokeStyle = '#444';
            ctx.lineWidth = 1;
            ctx.stroke();
          }
        }

        // Neighborhood initial in corner
        ctx.fillStyle = '#555';
        ctx.font = '7px Courier New';
        ctx.textAlign = 'right';
        ctx.fillText(p.neighborhood.substring(0, 3), x + CELL_W - 2, y + CELL_H - 3);
      }

      // Legend
      ctx.textAlign = 'left';
      ctx.font = '8px Courier New';
      let lx = MAP_X + 8;
      let ly = MAP_Y + MAP_H - 8;
      for (let t of types) {
        let info = PROP_TYPES[t];
        ctx.fillStyle = info.color;
        ctx.fillText('\u25A0 ' + info.label[0], lx, ly);
        lx += 42;
      }
      // Owner legend
      ctx.fillStyle = '#666';
      ctx.fillText('| Owners:', lx, ly);
      lx += 62;
      for (let i = 0; i < numPlayers; i++) {
        ctx.fillStyle = players[i].color;
        ctx.fillText('\u25A0', lx, ly);
        lx += 14;
      }
    }

    function drawPanel() {
      ctx.fillStyle = PANEL_BG;
      ctx.strokeStyle = ORANGE + '40';
      ctx.lineWidth = 1;
      roundRect(PANEL_X, PANEL_Y, PANEL_W, PANEL_H, 6, true, true);

      if (phase === 'event' && currentEvent) {
        ctx.fillStyle = '#ff0';
        ctx.font = 'bold 12px Courier New';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#ff0';
        ctx.shadowBlur = 10;
        ctx.fillText('\u26A0 MARKET NEWS \u26A0', PANEL_X + PANEL_W / 2, PANEL_Y + 28);
        ctx.shadowBlur = 0;

        ctx.fillStyle = ORANGE;
        ctx.font = 'bold 13px Courier New';
        wrapText(currentEvent.text, PANEL_X + PANEL_W / 2, PANEL_Y + 56, PANEL_W - 20, 16);

        ctx.fillStyle = '#ccc';
        ctx.font = '11px Courier New';
        wrapText(currentEvent.desc, PANEL_X + PANEL_W / 2, PANEL_Y + 82, PANEL_W - 20, 14);

        // Event log below
        ctx.fillStyle = '#555';
        ctx.font = '9px Courier New';
        ctx.textAlign = 'left';
        let ey = PANEL_Y + 120;
        for (let i = 1; i < eventLog.length && i < 7; i++) {
          let text = eventLog[i];
          if (text.length > 28) text = text.substring(0, 28) + '..';
          ctx.fillText(text, PANEL_X + 10, ey);
          ey += 13;
        }

        ctx.fillStyle = '#777';
        ctx.font = '10px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('Click to continue', PANEL_X + PANEL_W / 2, PANEL_Y + PANEL_H - 14);

      } else if (selectedProperty || hoveredProperty) {
        drawPropertyDetail(selectedProperty || hoveredProperty);
      } else {
        // Event log
        ctx.fillStyle = ORANGE;
        ctx.font = 'bold 11px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('\u2014 MARKET LOG \u2014', PANEL_X + PANEL_W / 2, PANEL_Y + 22);

        ctx.textAlign = 'left';
        ctx.font = '9px Courier New';
        let ey = PANEL_Y + 44;
        for (let i = 0; i < eventLog.length && i < 10; i++) {
          ctx.fillStyle = i === 0 ? '#ccc' : '#777';
          let text = eventLog[i];
          if (text.length > 28) text = text.substring(0, 28) + '..';
          ctx.fillText(text, PANEL_X + 10, ey);
          ey += 14;
        }

        if (eventLog.length === 0) {
          ctx.fillStyle = '#555';
          ctx.fillText('Hover a property', PANEL_X + 10, PANEL_Y + 52);
          ctx.fillText('for details', PANEL_X + 10, PANEL_Y + 68);
        }

        // Tips
        ctx.fillStyle = '#444';
        ctx.font = '9px Courier New';
        ctx.textAlign = 'center';
        ctx.fillText('Hover property for info', PANEL_X + PANEL_W / 2, PANEL_Y + PANEL_H - 14);
      }
    }

    function drawPropertyDetail(prop) {
      let info = PROP_TYPES[prop.type];
      let py = PANEL_Y + 14;

      ctx.textAlign = 'center';
      ctx.fillStyle = info.color;
      ctx.font = 'bold 13px Courier New';
      ctx.shadowColor = info.color;
      ctx.shadowBlur = 8;
      ctx.fillText(info.label.toUpperCase(), PANEL_X + PANEL_W / 2, py);
      ctx.shadowBlur = 0;
      py += 16;

      ctx.fillStyle = '#888';
      ctx.font = '10px Courier New';
      ctx.fillText('\u2302 ' + prop.neighborhood, PANEL_X + PANEL_W / 2, py);
      py += 22;

      ctx.textAlign = 'left';
      let lx = PANEL_X + 14;

      // Separator
      ctx.strokeStyle = '#333';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(lx, py - 6);
      ctx.lineTo(PANEL_X + PANEL_W - 14, py - 6);
      ctx.stroke();

      ctx.fillStyle = '#ddd';
      ctx.font = '11px Courier New';
      ctx.fillText('Value:     ' + fmt$(prop.value), lx, py); py += 18;

      let effRent = Math.round(prop.rent * prop.condition / 100);
      ctx.fillText('Rent:      ' + fmt$(effRent) + '/turn', lx, py); py += 18;

      // Condition bar
      ctx.fillText('Condition: ', lx, py);
      let barX = lx + 90, barW = 80, barH = 8;
      ctx.fillStyle = '#333';
      ctx.fillRect(barX, py - 8, barW, barH);
      let condCol = prop.condition > 60 ? '#4a9' : (prop.condition > 30 ? '#fa0' : '#f44');
      ctx.fillStyle = condCol;
      ctx.fillRect(barX, py - 8, barW * prop.condition / 100, barH);
      ctx.fillStyle = '#aaa';
      ctx.font = '9px Courier New';
      ctx.textAlign = 'right';
      ctx.fillText(prop.condition + '%', PANEL_X + PANEL_W - 14, py);
      ctx.textAlign = 'left';
      ctx.font = '11px Courier New';
      py += 18;

      // Dev level
      ctx.fillStyle = '#ddd';
      ctx.fillText('Dev Level: ', lx, py);
      for (let d = 0; d < prop.maxDev; d++) {
        let dx = lx + 90 + d * 18;
        if (d < prop.devLevel) {
          ctx.fillStyle = '#ff0';
          ctx.fillText('\u2605', dx, py);
        } else {
          ctx.fillStyle = '#444';
          ctx.fillText('\u2606', dx, py);
        }
      }
      py += 22;

      // Owner
      if (prop.owner >= 0) {
        ctx.fillStyle = players[prop.owner].color;
        ctx.font = 'bold 11px Courier New';
        ctx.fillText('Owner: ' + players[prop.owner].name, lx, py);
      } else {
        ctx.fillStyle = '#5a5';
        ctx.font = 'bold 11px Courier New';
        ctx.fillText('\u2713 AVAILABLE', lx, py);
      }
      py += 24;

      // Separator
      ctx.strokeStyle = '#333';
      ctx.beginPath();
      ctx.moveTo(lx, py - 8);
      ctx.lineTo(PANEL_X + PANEL_W - 14, py - 8);
      ctx.stroke();

      // Stats
      ctx.font = '10px Courier New';
      let roi = ((effRent) / prop.value * 100).toFixed(1);
      ctx.fillStyle = '#999';
      ctx.fillText('ROI: ' + roi + '% per turn', lx, py); py += 14;

      if (prop.devLevel < prop.maxDev) {
        let dc = getDevCost(prop);
        ctx.fillText('Dev cost: ' + fmt$(dc), lx, py); py += 14;
        if (devDiscount < 1.0) {
          ctx.fillStyle = '#5d5';
          ctx.fillText('  (discounted!)', lx + 80, py - 14);
        }
      }

      if (prop.owner === 0) {
        ctx.fillStyle = '#f88';
        ctx.fillText('Sell price: ' + fmt$(Math.round(prop.value * 0.9)), lx, py);
      } else if (prop.owner === -1) {
        ctx.fillStyle = '#5a5';
        ctx.fillText('Buy price: ' + fmt$(prop.value), lx, py);
      }
    }

    function drawStats() {
      ctx.fillStyle = PANEL_BG;
      ctx.strokeStyle = ORANGE + '40';
      ctx.lineWidth = 1;
      roundRect(STATS_X, STATS_Y, STATS_W, STATS_H, 6, true, true);

      let colW = STATS_W / numPlayers;
      for (let i = 0; i < numPlayers; i++) {
        let px = STATS_X + i * colW + 10;
        let py = STATS_Y + 16;
        let pl = players[i];
        let nw = getPlayerNetWorth(i);
        let propCount = getPlayerPropertyCount(i);

        // Highlight current player during action phase
        if (i === 0 && phase === 'action') {
          ctx.fillStyle = pl.color + '15';
          roundRect(STATS_X + i * colW + 2, STATS_Y + 2, colW - 4, STATS_H - 4, 4, true, false);
        }

        ctx.fillStyle = pl.color;
        ctx.font = 'bold 11px Courier New';
        ctx.textAlign = 'left';
        if (i === 0) {
          ctx.shadowColor = pl.color;
          ctx.shadowBlur = 6;
        }
        ctx.fillText(pl.name, px, py);
        ctx.shadowBlur = 0;

        ctx.fillStyle = '#ccc';
        ctx.font = '10px Courier New';
        ctx.fillText(fmt$(pl.cash), px, py + 16);

        ctx.fillStyle = '#888';
        ctx.font = '9px Courier New';
        ctx.fillText('NW:' + fmt$(nw), px, py + 30);
        ctx.fillText(propCount + ' props', px, py + 42);
      }
    }

    function drawActions() {
      ctx.fillStyle = PANEL_BG;
      ctx.strokeStyle = ORANGE + '40';
      ctx.lineWidth = 1;
      roundRect(ACTION_X, ACTION_Y, ACTION_W, ACTION_H, 6, true, true);

      buttons = [];

      if (phase === 'event') {
        ctx.fillStyle = '#ff0';
        ctx.font = 'bold 13px Courier New';
        ctx.textAlign = 'center';
        ctx.shadowColor = '#ff0';
        ctx.shadowBlur = 8;
        ctx.fillText('\u26A0 ' + (currentEvent ? currentEvent.text : '') + ' \u26A0', ACTION_X + ACTION_W / 2, ACTION_Y + 30);
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#bbb';
        ctx.font = '11px Courier New';
        ctx.fillText(currentEvent ? currentEvent.desc : '', ACTION_X + ACTION_W / 2, ACTION_Y + 50);
        ctx.fillStyle = '#666';
        ctx.font = '10px Courier New';
        let pulse = Math.sin(animTimer * 3) * 0.3 + 0.7;
        ctx.globalAlpha = pulse;
        ctx.fillText('Click anywhere to continue', ACTION_X + ACTION_W / 2, ACTION_Y + 72);
        ctx.globalAlpha = 1.0;

      } else if (phase === 'action') {
        ctx.fillStyle = ORANGE;
        ctx.font = 'bold 11px Courier New';
        ctx.textAlign = 'left';
        let actionsLeft = maxActions - actionsTaken;
        ctx.fillText('YOUR TURN  |  Actions: ' + actionsLeft + '  |  Cash: ' + fmt$(players[0].cash), ACTION_X + 12, ACTION_Y + 18);

        if (rentCollected > 0) {
          ctx.fillStyle = '#5d5';
          ctx.font = '9px Courier New';
          ctx.textAlign = 'right';
          ctx.fillText('Rent collected: +' + fmt$(rentCollected), ACTION_X + ACTION_W - 12, ACTION_Y + 18);
        }

        let bx = ACTION_X + 12;
        let by = ACTION_Y + 28;
        let bw = 120, bh = 26, gap = 12;

        let canBuy = selectedProperty && selectedProperty.owner === -1 && players[0].cash >= selectedProperty.value;
        drawButton(bx, by, bw, bh, '\u25B6 BUY', canBuy ? '#4a9' : '#444', canBuy, 'buy');
        bx += bw + gap;

        let canDev = selectedProperty && selectedProperty.owner === 0 && selectedProperty.devLevel < selectedProperty.maxDev && players[0].cash >= getDevCost(selectedProperty);
        drawButton(bx, by, bw, bh, '\u2605 DEVELOP', canDev ? '#49f' : '#444', canDev, 'develop');
        bx += bw + gap;

        let canSell = selectedProperty && selectedProperty.owner === 0;
        drawButton(bx, by, bw, bh, '\u25C0 SELL', canSell ? '#f55' : '#444', canSell, 'sell');
        bx += bw + gap;

        drawButton(bx, by, bw, bh, '\u23ED END TURN', '#f90', true, 'endTurn');

        ctx.fillStyle = '#666';
        ctx.font = '9px Courier New';
        ctx.textAlign = 'left';
        if (!selectedProperty) {
          ctx.fillText('Select a property on the map to take action', ACTION_X + 12, ACTION_Y + 74);
        } else {
          let info = PROP_TYPES[selectedProperty.type];
          ctx.fillStyle = info.color;
          ctx.fillText('Selected: ' + info.label + ' in ' + selectedProperty.neighborhood + ' (' + fmt$(selectedProperty.value) + ')', ACTION_X + 12, ACTION_Y + 74);
        }

      } else if (phase === 'gameOver') {
        ctx.fillStyle = ORANGE;
        ctx.font = 'bold 14px Courier New';
        ctx.textAlign = 'center';
        ctx.shadowColor = ORANGE;
        ctx.shadowBlur = 12;
        ctx.fillText('GAME OVER', ACTION_X + ACTION_W / 2, ACTION_Y + 35);
        ctx.shadowBlur = 0;
        ctx.fillStyle = '#aaa';
        ctx.font = '11px Courier New';
        ctx.fillText('Final Net Worth: ' + fmt$(getPlayerNetWorth(0)), ACTION_X + ACTION_W / 2, ACTION_Y + 56);
        ctx.fillStyle = '#666';
        ctx.font = '10px Courier New';
        ctx.fillText('Click to play again', ACTION_X + ACTION_W / 2, ACTION_Y + 74);
      }
    }

    function drawButton(x, y, w, h, text, color, active, action) {
      let isHov = hoveredButton && hoveredButton.action === action && active;

      ctx.fillStyle = active ? (isHov ? color + '60' : color + '25') : '#181830';
      ctx.strokeStyle = active ? color : '#333';
      ctx.lineWidth = isHov ? 2 : 1;

      if (isHov) {
        ctx.shadowColor = color;
        ctx.shadowBlur = 10;
      }

      roundRect(x, y, w, h, 4, true, true);
      ctx.shadowBlur = 0;

      ctx.fillStyle = active ? (isHov ? '#fff' : '#ddd') : '#444';
      ctx.font = 'bold 10px Courier New';
      ctx.textAlign = 'center';
      ctx.fillText(text, x + w / 2, y + h / 2 + 4);

      buttons.push({ x, y, w, h, action, active });
    }

    function roundRect(x, y, w, h, r, fill, stroke) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }

    function wrapText(text, x, y, maxW, lineH) {
      let words = text.split(' ');
      let line = '';
      for (let w of words) {
        let test = line + w + ' ';
        if (ctx.measureText(test).width > maxW && line.length > 0) {
          ctx.fillText(line.trim(), x, y);
          line = w + ' ';
          y += lineH;
        } else {
          line = test;
        }
      }
      ctx.fillText(line.trim(), x, y);
    }

    // ====== INPUT ======

    function getPropertyAt(mx, my) {
      for (let p of properties) {
        if (mx >= p.x && mx <= p.x + CELL_W && my >= p.y && my <= p.y + CELL_H) return p;
      }
      return null;
    }

    function getButtonAt(mx, my) {
      for (let b of buttons) {
        if (mx >= b.x && mx <= b.x + b.w && my >= b.y && my <= b.y + b.h) return b;
      }
      return null;
    }

    canvas.addEventListener('mousemove', (e) => {
      let rect = canvas.getBoundingClientRect();
      let mx = (e.clientX - rect.left) * (W / rect.width);
      let my = (e.clientY - rect.top) * (H / rect.height);
      hoveredProperty = getPropertyAt(mx, my);
      hoveredButton = getButtonAt(mx, my);
    });

    canvas.addEventListener('click', (e) => {
      let rect = canvas.getBoundingClientRect();
      let mx = (e.clientX - rect.left) * (W / rect.width);
      let my = (e.clientY - rect.top) * (H / rect.height);

      if (gameState === 'waiting') {
        gameState = 'playing';
        overlay.style.display = 'none';
        initGame();
        return;
      }

      if (gameState === 'over') {
        gameState = 'waiting';
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'REAL ESTATE MOGUL';
        overlayText.innerHTML = 'Buy, develop, and sell properties to become the wealthiest tycoon.<br><br>Click to Start';
        return;
      }

      if (phase === 'event') {
        rentCollected = collectRent(0);
        phase = 'action';
        actionsTaken = 0;
        updateScore();
        return;
      }

      if (phase === 'action') {
        let btn = getButtonAt(mx, my);
        if (btn && btn.active) {
          handleAction(btn.action);
          return;
        }
        let prop = getPropertyAt(mx, my);
        if (prop) {
          selectedProperty = prop;
        }
        return;
      }

      if (phase === 'gameOver') {
        gameState = 'waiting';
        overlay.style.display = 'flex';
        overlayTitle.textContent = 'REAL ESTATE MOGUL';
        overlayText.innerHTML = 'Buy, develop, and sell properties to become the wealthiest tycoon.<br><br>Click to Start';
      }
    });

    function handleAction(action) {
      if (phase !== 'action') return;

      if (action === 'endTurn') {
        selectedProperty = null;
        advanceTurn();
        return;
      }

      if (!selectedProperty) return;

      let success = false;
      if (action === 'buy') {
        success = buyProperty(selectedProperty, 0);
      } else if (action === 'develop') {
        success = developProperty(selectedProperty);
      } else if (action === 'sell') {
        success = sellProperty(selectedProperty);
        if (success) selectedProperty = null;
      }

      if (success) {
        actionsTaken++;
        updateScore();
        if (actionsTaken >= maxActions) {
          advanceTurn();
        }
      }
    }

    function updateScore() {
      let nw = getPlayerNetWorth(0);
      score = nw;
      scoreEl.textContent = nw.toLocaleString();
    }

    function gameLoop() {
      draw();
      requestAnimationFrame(gameLoop);
    }

    overlay.style.display = 'flex';
    gameLoop();
  </script>
  <script src="../recorder.js?v=2"></script>
</body>
</html>
